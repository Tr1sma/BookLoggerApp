@page "/"
@page "/bookshelf"
@using BookLoggerApp.Core.ViewModels
@using BookLoggerApp.Core.Models
@using BookLoggerApp.Core.Enums
@using BookLoggerApp.Core.Services.Abstractions
@using BookLoggerApp.Components.Shared
@inject BookshelfViewModel ViewModel
@inject Microsoft.AspNetCore.Components.NavigationManager Navigation
@inject IGoalService GoalService
@inject BookLoggerApp.Core.Services.Abstractions.IBackButtonService BackButtonService
@inject WishlistViewModel WishlistVM
@inject BookLoggerApp.Services.IScannerService ScannerService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Bookshelf - BookHeart</PageTitle>

<div class="bookshelf-container">
    <!-- Reading Goal Header -->
    <GoalHeader TbrCount="@ViewModel.TbrCount" GoalTarget="@ViewModel.GoalTarget"
        BooksRead="@ViewModel.BooksReadThisYear" BooksRemaining="@ViewModel.BooksRemainingToGoal" />

    <!-- Tab Bar -->
    <div class="bookshelf-tabs">
        <button class="tab-btn @(activeTab == "shelves" ? "active" : "")"
                @onclick='() => SwitchTab("shelves")'>
            Shelves
        </button>
        <button class="tab-btn @(activeTab == "wishlist" ? "active" : "")"
                @onclick='() => SwitchTab("wishlist")'>
            Wishlist
            @if (WishlistVM.WishlistCount > 0)
            {
                <span class="wishlist-count-badge">@WishlistVM.WishlistCount</span>
            }
        </button>
    </div>

    @if (activeTab == "shelves")
    {
    <!-- Header & Controls -->
    <div class="bookshelf-header">
        <h1>My Bookshelf</h1>
        <div class="bookshelf-controls">
            <input type="text" class="search-input" placeholder="Search books..."
                   value="@ViewModel.SearchQuery"
                   @oninput="HandleSearchInput" />
        </div>
    </div>

    <!-- Filters & Sort (Collapsible) -->
    <div class="bookshelf-filters-wrapper">
        <button class="filter-toggle-btn" @onclick="ToggleFilters">
            <span>@(filtersExpanded ? "‚ñº" : "‚ñ∂") Filters & Sort</span>
            @if (HasActiveFilters())
            {
                <span class="active-filter-badge">Active</span>
            }
        </button>

        <div class="bookshelf-filters @(filtersExpanded ? "expanded" : "collapsed")">
            <!-- Existing filters... -->
            <div class="filter-group">
                <label>Sort by:</label>
                <select value="@ViewModel.SortBy"
                @onchange="@((ChangeEventArgs e) => { ViewModel.SortBy = e.Value?.ToString() ?? "Title"; HandleSearch(); })">
                    <option value="Title">Title</option>
                    <option value="Author">Author</option>
                    <option value="DateAdded">Date Added</option>
                    <option value="Status">Status</option>
                </select>
            </div>
            <!-- ... (Keeping filters simple for now, as search clears shelves) -->
            <div class="filter-group">
                <button class="btn btn-secondary" @onclick="HandleClearFilters">Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Book Grid / Shelves -->
    @if (ViewModel.IsBusy)
    {
        <div class="loading">Loading your books...</div>
    }
    else if (!string.IsNullOrEmpty(ViewModel.SearchQuery) || ViewModel.FilterStatus.HasValue ||
    ViewModel.FilterGenreId.HasValue)
    {
        <!-- Search Results View (Flat Grid) -->
        <div class="search-results-label">Search Results: @ViewModel.Books.Count book(s)</div>
        <div class="book-grid">
            <div class="shelf-row">
                <Virtualize Items="@ViewModel.Books" Context="book" OverscanCount="5">
                    <div class="shelf-slot">
                        <BookCard Book="@book" IsInBookshelf="true" OnClick="() => HandleBookClick(book)"
                            OnDelete="() => HandleDeleteBook(book.Id)" />
                    </div>
                </Virtualize>
            </div>
        </div>
    }
    else
    {
        <!-- Shelves View -->
        <div class="shelves-container">
            @{ var hasAvailablePlants = ViewModel.AvailablePlants.Any(); }
            @for (var shelfIndex = 0; shelfIndex < ViewModel.Shelves.Count; shelfIndex++)
            {
                var shelfVM = ViewModel.Shelves[shelfIndex];
                var isFirst = shelfIndex == 0;
                var isLast = shelfIndex == ViewModel.Shelves.Count - 1;

                <div @key="shelfVM.Shelf.Id"
                     class="shelf-section @(shelfVM.IsExpanded ? "" : "collapsed")"
                     data-shelf-id="@shelfVM.Shelf.Id"
                     data-auto-sort="@(shelfVM.Shelf.AutoSortRule != ShelfAutoSortRule.None ? "true" : "false")">

                    <div class="shelf-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="btn-icon toggle-icon @(shelfVM.IsExpanded ? "" : "collapsed")"
                            @onclick="() => shelfVM.IsExpanded = !shelfVM.IsExpanded">
                                ‚ñº
                            </button>
                            <h3>@shelfVM.Shelf.Name</h3>
                            <!-- Reordering Controls -->
                            <div class="shelf-reorder-controls" style="display: flex; gap: 2px; margin-left: 10px;">
                                <button class="btn-icon small"
                                @onclick="() => ViewModel.MoveShelfUpCommand.ExecuteAsync(shelfVM.Shelf.Id)"
                                    disabled="@isFirst" title="Move Up">
                                    ‚¨ÜÔ∏è
                                </button>
                                <button class="btn-icon small"
                                @onclick="() => ViewModel.MoveShelfDownCommand.ExecuteAsync(shelfVM.Shelf.Id)"
                                    disabled="@isLast"
                                    title="Move Down">
                                    ‚¨áÔ∏è
                                </button>
                            </div>
                        </div>

                        <div class="shelf-actions">
                            @if (shelfVM.Shelf.SortOrder > 0)
                            {
                                <button class="btn-icon" @onclick="() => HandleDeleteShelf(shelfVM.Shelf.Id)"
                                    title="Delete Shelf">üóëÔ∏è</button>
                            }
                        </div>
                    </div>
                    @if (shelfVM.IsExpanded)
                    {
                        <div class="shelf-books">
                            <!-- Mixed Items Loop -->
                            @foreach (var item in shelfVM.Items)
                            {
                                @if (item.Type == ShelfItemType.Book && item.Book != null)
                                {
                                    <div @key="item.Book.Id"
                                         class="shelf-slot"
                                         data-item-id="@item.Book.Id"
                                         data-item-type="Book"
                                         data-shelf-id="@shelfVM.Shelf.Id">
                                        <BookCard Book="@item.Book" IsInBookshelf="true"
                                            OnClick="() => HandleBookClick(item.Book)"
                                            OnDelete="() => HandleRemoveBookFromShelf(item.Book.Id, shelfVM.Shelf.Id)" />
                                    </div>
                                }
                                else if (item.Type == ShelfItemType.Plant && item.Plant != null)
                                {
                                    <div @key="item.Plant.Id"
                                         class="shelf-slot"
                                         data-item-id="@item.Plant.Id"
                                         data-item-type="Plant"
                                         data-shelf-id="@shelfVM.Shelf.Id">
                                        <PlantCard Plant="@item.Plant" IsInBookshelf="true"
                                            OnClick="() => HandlePlantClick(item.Plant)"
                                            OnRemove="() => HandleRemovePlant(item.Plant.Id, shelfVM.Shelf.Id)" />
                                    </div>
                                }
                            }

                            <!-- Add Plant Button -->
                            @if (hasAvailablePlants)
                            {
                                <div class="empty-slot" @onclick="() => HandleAddPlant(shelfVM.Shelf.Id)">
                                    <div class="empty-slot-icon">üå±</div>
                                    <div class="empty-slot-text">Add Plant</div>
                                </div>
                            }
                        </div>
                        <div class="shelf-wood-base"></div>
                    }
                </div>
            }
        </div>
    }
    <!-- Floating Action Buttons (Shelves Tab) -->
    <div class="fab-container">
        <button class="fab-button secondary" @onclick="OpenAddShelfModal" title="New Shelf">
            üìö
        </button>
        <button class="fab-button" @onclick="NavigateToAddBook" title="Add Book">
            +
        </button>
    </div>
    } @* end activeTab == "shelves" *@

    @if (activeTab == "wishlist")
    {
    <!-- Wishlist Content -->
    <div class="wishlist-controls">
        <input type="text" class="search-input" placeholder="Search wishlist..."
               value="@WishlistVM.SearchQuery"
               @oninput="HandleWishlistSearchInput" />
        <select class="wishlist-sort-select" value="@WishlistVM.SortBy"
                @onchange="HandleWishlistSort">
            <option value="DateAdded">Date Added</option>
            <option value="Priority">Priority</option>
            <option value="Title">Title</option>
            <option value="Author">Author</option>
        </select>
    </div>

    @if (WishlistVM.IsBusy)
    {
        <div class="loading">Loading wishlist...</div>
    }
    else if (!WishlistVM.WishlistBooks.Any())
    {
        <div class="wishlist-empty">
            <div class="wishlist-empty-icon">üíù</div>
            <div class="wishlist-empty-text">Your wishlist is empty</div>
            <div class="wishlist-empty-hint">Tap + to add books you want to read</div>
        </div>
    }
    else
    {
        <div class="wishlist-book-list">
            @foreach (var book in WishlistVM.WishlistBooks)
            {
                <div class="wishlist-card" @onclick="() => HandleBookClick(book)">
                    <div class="wishlist-card-cover">
                        @if (!string.IsNullOrEmpty(book.CoverImagePath))
                        {
                            <img src="@book.CoverImagePath" alt="@book.Title" />
                        }
                        else
                        {
                            <span class="no-cover">üìñ</span>
                        }
                    </div>
                    <div class="wishlist-card-info">
                        <div class="wishlist-card-title">@book.Title</div>
                        <div class="wishlist-card-author">@book.Author</div>
                        <div class="wishlist-card-meta">
                            @if (book.WishlistInfo != null)
                            {
                                <span class="wishlist-priority priority-@book.WishlistInfo.Priority.ToString().ToLower()">
                                    @book.WishlistInfo.Priority
                                </span>
                                @if (!string.IsNullOrEmpty(book.WishlistInfo.RecommendedBy))
                                {
                                    <span class="wishlist-card-recommended">
                                        via @book.WishlistInfo.RecommendedBy
                                    </span>
                                }
                            }
                        </div>
                    </div>
                    <div class="wishlist-card-actions" @onclick:stopPropagation="true">
                        <button class="btn-icon" @onclick="() => NavigateToEditBook(book.Id)" title="Edit & Add to Shelf">
                            üìö
                        </button>
                        <button class="btn-icon danger" @onclick="() => HandleRemoveFromWishlist(book.Id)" title="Remove">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Floating Action Button (Wishlist Tab) -->
    <div class="fab-container">
        <button class="fab-button" @onclick="OpenAddToWishlistModal" title="Add to Wishlist">
            +
        </button>
    </div>
    } @* end activeTab == "wishlist" *@
</div>

<!-- Add Shelf Modal -->
@if (showAddShelfModal)
{
    <div class="modal-overlay" @onclick="CloseAddShelfModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Add New Bookshelf</h3>
            <div class="form-group">
                <label>Name</label>
                <input type="text" @bind="newShelfName" class="form-control" placeholder="e.g. Favorites, TBR..." />
            </div>
            <div class="form-group">
                <label>Auto-Sort Rule</label>
                <select @bind="newShelfRule" class="form-control">
                    <option value="@ShelfAutoSortRule.None">Manual (Drag & Drop)</option>
                    <option value="@ShelfAutoSortRule.StatusPlanned">Planned (TBR)</option>
                    <option value="@ShelfAutoSortRule.StatusReading">Currently Reading</option>
                    <option value="@ShelfAutoSortRule.StatusCompleted">Read / Completed</option>
                    <option value="@ShelfAutoSortRule.StatusWishlist">Wishlist</option>
                </select>
                <small>Auto-sort shelves automatically include books matching the status.</small>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="CloseAddShelfModal">Cancel</button>
                <button class="btn btn-primary" @onclick="CreateShelf">Create Shelf</button>
            </div>
        </div>
    </div>
}

<!-- ... Plant/Book Modals (Keep existing ones) ... -->
<!-- Plant Detail Modal -->
@if (showPlantDetail && selectedPlant != null)
{
    <div class="purchase-modal-overlay" @onclick="ClosePlantDetail">
        <div class="purchase-modal plant-detail-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>üå± @selectedPlant.Name</h2>
                <button class="btn-close" @onclick="ClosePlantDetail">√ó</button>
            </div>
            <div class="modal-body">
                <PlantWidget Plant="@selectedPlant" OnWater="HandleWaterPlantFromModal"
                    OnDelete="HandleDeletePlantFromModal" IsWatering="@isWateringPlant" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="ClosePlantDetail">Close</button>
            </div>
        </div>
    </div>
}

<!-- Plant Selector Modal -->
@if (showPlantSelector)
{
    <div class="modal-overlay" @onclick="ClosePlantSelector">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Select a Plant</h3>
            <div class="plant-selector-grid" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 0;">
                @if (ViewModel.AvailablePlants.Any())
                {
                    @foreach (var plant in ViewModel.AvailablePlants)
                    {
                        <div class="plant-select-item" @onclick="() => SelectPlantForBookshelf(plant)"
                            style="cursor: pointer; transform: scale(0.9);">
                            <PlantCard Plant="@plant" IsInBookshelf="false" />
                        </div>
                    }
                }
                else
                {
                    <p style="color: #ccc; width: 100%; text-align: center;">No plants available. Visit the shop?</p>
                    <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/shop"))" style="width: 100%;">Go
                        to Shop</button>
                }
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="ClosePlantSelector">Cancel</button>
            </div>
        </div>
    </div>
}
<!-- Delete Shelf Confirmation Modal -->
@if (showDeleteShelfModal)
{
    <div class="modal-overlay" @onclick="CloseDeleteShelfModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Delete Shelf</h3>
            <p>Are you sure you want to delete this shelf? All items will be moved to the Main Shelf.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="CloseDeleteShelfModal">Cancel</button>
                <button class="btn btn-danger" @onclick="ConfirmDeleteShelf">Delete</button>
            </div>
        </div>
    </div>
}

<!-- Add to Wishlist Modal -->
@if (showAddToWishlistModal)
{
    <div class="modal-overlay" @onclick="CloseAddToWishlistModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Add to Wishlist</h3>
            <div class="wishlist-form">
                <div class="wishlist-isbn-row">
                    <div class="form-group">
                        <label>ISBN</label>
                        <input type="text" class="form-control" placeholder="Enter ISBN..."
                               @bind="WishlistVM.NewIsbn" />
                    </div>
                    <button class="btn-icon wishlist-isbn-btn"
                            @onclick="ScanWishlistIsbnAsync" title="Scan Barcode">
                        üì∑
                    </button>
                    <button class="btn-icon wishlist-isbn-btn"
                            @onclick="HandleWishlistLookup" disabled="@WishlistVM.IsLookingUp"
                            title="Lookup ISBN">
                        üîç
                    </button>
                </div>
                @if (WishlistVM.LookupMessage != null)
                {
                    <div class="wishlist-lookup-msg @(WishlistVM.LookupMessage.Contains("found") ? "success" : "error")">
                        @WishlistVM.LookupMessage
                    </div>
                }
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" class="form-control" placeholder="Book title..."
                           @bind="WishlistVM.NewTitle" />
                </div>
                <div class="form-group">
                    <label>Author *</label>
                    <input type="text" class="form-control" placeholder="Author name..."
                           @bind="WishlistVM.NewAuthor" />
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <div class="priority-select">
                        <button class="priority-option @(WishlistVM.NewPriority == WishlistPriority.Low ? "selected" : "")"
                                @onclick="() => WishlistVM.NewPriority = WishlistPriority.Low">Low</button>
                        <button class="priority-option @(WishlistVM.NewPriority == WishlistPriority.Medium ? "selected" : "")"
                                @onclick="() => WishlistVM.NewPriority = WishlistPriority.Medium">Medium</button>
                        <button class="priority-option @(WishlistVM.NewPriority == WishlistPriority.High ? "selected" : "")"
                                @onclick="() => WishlistVM.NewPriority = WishlistPriority.High">High</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>Recommended by</label>
                    <input type="text" class="form-control" placeholder="Who recommended this?"
                           @bind="WishlistVM.NewRecommendedBy" />
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea class="form-control" placeholder="Why do you want to read this?"
                              @bind="WishlistVM.NewWishlistNotes"></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="CloseAddToWishlistModal">Cancel</button>
                <button class="btn btn-primary" @onclick="HandleAddToWishlist"
                        disabled="@(string.IsNullOrWhiteSpace(WishlistVM.NewTitle))">Add</button>
            </div>
        </div>
    </div>
}

@code {
    private string activeTab = "shelves";
    private bool filtersExpanded = false;
    private bool showAddShelfModal = false;
    private string newShelfName = "";
    private ShelfAutoSortRule newShelfRule = ShelfAutoSortRule.None;
    private bool showAddToWishlistModal = false;

    // Plant state
    private bool showPlantDetail;
    private UserPlant? selectedPlant;
    private bool isWateringPlant;

    // JS Drag & Drop interop
    private DotNetObjectReference<Bookshelf>? _dotNetHelper;
    private bool _jsInitialized = false;

    // Back handler
    private Func<Task<bool>>? _activeBackHandler;

    protected override async Task OnInitializedAsync()
    {
        GoalService.GoalsChanged += OnGoalsChanged;
        await ViewModel.LoadCommand.ExecuteAsync(null);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!_jsInitialized && ViewModel.Shelves.Any() && activeTab == "shelves")
        {
            _dotNetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("bookshelfDragDrop.init", _dotNetHelper);
            _jsInitialized = true;
        }
    }

    private async void OnGoalsChanged(object? sender, EventArgs e)
    {
        await InvokeAsync(async () =>
        {
            // Only refresh goal header stats ‚Äî shelves are unchanged
            await ViewModel.RefreshGoalStatsAsync();
            StateHasChanged();
        });
    }

    public async ValueTask DisposeAsync()
    {
        GoalService.GoalsChanged -= OnGoalsChanged;
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
        _searchTimer?.Stop();
        _searchTimer?.Dispose();
        _wishlistSearchTimer?.Stop();
        _wishlistSearchTimer?.Dispose();
        try
        {
            await JSRuntime.InvokeVoidAsync("bookshelfDragDrop.dispose");
        }
        catch { /* Ignore if JS runtime already gone */ }
        _dotNetHelper?.Dispose();
    }

    private void ToggleFilters() => filtersExpanded = !filtersExpanded;
    private bool HasActiveFilters() => ViewModel.FilterStatus.HasValue || ViewModel.FilterGenreId.HasValue ||
    !string.IsNullOrWhiteSpace(ViewModel.SearchQuery);
    private System.Timers.Timer? _searchTimer;

    private void HandleSearchInput(ChangeEventArgs e)
    {
        var searchText = e.Value?.ToString() ?? "";
        ViewModel.SearchQuery = searchText;

        _searchTimer?.Stop();
        _searchTimer?.Dispose();

        _searchTimer = new System.Timers.Timer(300);
        _searchTimer.Elapsed += async (sender, args) =>
        {
            _searchTimer?.Stop();
            try
            {
                await InvokeAsync(async () =>
                {
                    await ViewModel.SearchCommand.ExecuteAsync(null);
                    StateHasChanged();
                });
            }
            catch (ObjectDisposedException) { }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Search failed: {ex.Message}");
            }
        };
        _searchTimer.Start();
    }

    private void HandleSearch() => ViewModel.SearchCommand.ExecuteAsync(null);
    private async Task HandleClearFilters()
    {
        ViewModel.ClearFiltersCommand.Execute(null);
        await ViewModel.LoadCommand.ExecuteAsync(null);
        _jsInitialized = false;
    }
    private void NavigateToAddBook() => Navigation.NavigateTo("/books/new");
    private void HandleBookClick(Book book) => Navigation.NavigateTo($"/books/{book.Id}");

    // Shelf Logic
    private void OpenAddShelfModal()
    {
        newShelfName = "";
        newShelfRule = ShelfAutoSortRule.None;

        // Register back handler
        _activeBackHandler = async () =>
        {
            CloseAddShelfModal();
            return true;
        };
        BackButtonService.Register(_activeBackHandler);

        showAddShelfModal = true;
    }

    private void CloseAddShelfModal()
    {
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
        showAddShelfModal = false;
    }

    private async Task CreateShelf()
    {
        if (string.IsNullOrWhiteSpace(newShelfName)) return;
        await ViewModel.CreateShelfCommand.ExecuteAsync((newShelfName, newShelfRule));
        CloseAddShelfModal();
    }

    private Guid? shelfToDeleteId;
    private bool showDeleteShelfModal;

    private void HandleDeleteShelf(Guid shelfId)
    {
        shelfToDeleteId = shelfId;

        // Register back handler
        _activeBackHandler = async () =>
        {
            CloseDeleteShelfModal();
            return true;
        };
        BackButtonService.Register(_activeBackHandler);

        showDeleteShelfModal = true;
    }

    private void CloseDeleteShelfModal()
    {
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
        showDeleteShelfModal = false;
        shelfToDeleteId = null;
    }

    private async Task ConfirmDeleteShelf()
    {
        if (shelfToDeleteId.HasValue)
        {
            await ViewModel.DeleteShelfCommand.ExecuteAsync(shelfToDeleteId.Value);
            CloseDeleteShelfModal();
        }
    }

    // ‚îÄ‚îÄ‚îÄ JS Drag & Drop Callbacks ‚îÄ‚îÄ‚îÄ

    [JSInvokable]
    public async Task OnReorderItem(string sourceShelfId, string itemId, string itemType, string targetItemId)
    {
        var shelfGuid = Guid.Parse(sourceShelfId);
        var sourceGuid = Guid.Parse(itemId);
        var targetGuid = Guid.Parse(targetItemId);
        await ViewModel.ReorderShelfItemsAsync((shelfGuid, sourceGuid, targetGuid));
        StateHasChanged();
        // JS drag-drop stays initialized ‚Äî Blazor diffs the DOM, no re-init needed
    }

    [JSInvokable]
    public async Task OnMoveItemToShelf(string sourceShelfId, string targetShelfId,
        string itemId, string itemType, int position)
    {
        var sourceGuid = Guid.Parse(sourceShelfId);
        var targetGuid = Guid.Parse(targetShelfId);
        var itemGuid = Guid.Parse(itemId);
        var type = itemType == "Plant" ? ShelfItemType.Plant : ShelfItemType.Book;

        // Optimistic in-memory move for instant visual feedback
        ViewModel.MoveItemBetweenShelvesInMemory(sourceGuid, targetGuid, itemGuid, type, position);
        StateHasChanged();

        // Persist to database in background (no full reload)
        await ViewModel.PersistCrossShelfMoveAsync(sourceGuid, targetGuid, itemGuid, type, position);
    }

    private async Task HandleRemoveBookFromShelf(Guid bookId, Guid shelfId)
    {
        // On the shelf view, the 'delete' type action removes it from the shelf, not the library
        // Unless it's the AutoSort shelf?
        // For manual shelves: Remove from shelf.
        // For AutoSort shelves: Can't really remove unless changing status.
        // Let's assume standard behavior is Remove from Shelf.

        await ViewModel.RemoveBookFromShelfCommand.ExecuteAsync((bookId, shelfId));
    }

    private async Task HandleDeleteBook(Guid bookId)
    {
        // For search results view, delete permanently
        await ViewModel.DeleteBookCommand.ExecuteAsync(bookId);
    }

    // Plant stubs
    private void HandlePlantClick(UserPlant plant)
    {
        selectedPlant = plant;

        // Register back handler
        _activeBackHandler = async () =>
        {
            ClosePlantDetail();
            return true;
        };
        BackButtonService.Register(_activeBackHandler);

        showPlantDetail = true;
    }
    private void ClosePlantDetail()
    {
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
        showPlantDetail = false;
        selectedPlant = null;
    }
    private async Task HandleWaterPlantFromModal()
    {
        if (selectedPlant != null) await
        ViewModel.WaterPlantCommand.ExecuteAsync(selectedPlant.Id);
    }
    private async Task HandleDeletePlantFromModal()
    {
        if (selectedPlant != null)
        {
            await
            ViewModel.DeletePlantCommand.ExecuteAsync(selectedPlant.Id); ClosePlantDetail();
        }
    }
    private async Task HandleRemovePlant(Guid plantId, Guid shelfId) => await
    ViewModel.RemovePlantFromShelfCommand.ExecuteAsync((plantId, shelfId));
    private bool showPlantSelector;
    private Guid? targetShelfForPlant;

    private void HandleAddPlant(Guid shelfId)
    {
        targetShelfForPlant = shelfId;

        // Register back handler
        _activeBackHandler = async () =>
        {
            ClosePlantSelector();
            return true;
        };
        BackButtonService.Register(_activeBackHandler);

        showPlantSelector = true;
    }

    private void ClosePlantSelector()
    {
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
        showPlantSelector = false;
        targetShelfForPlant = null;
    }

    private async Task SelectPlantForBookshelf(UserPlant plant)
    {
        if (targetShelfForPlant.HasValue)
        {
            await ViewModel.AddPlantToShelfCommand.ExecuteAsync((plant.Id, targetShelfForPlant.Value));
        }
        ClosePlantSelector();
    }

    private string GetPlantStatusIcon(PlantStatus status) => status switch
    {
        PlantStatus.Healthy => "üòä",
        PlantStatus.Thirsty => "üò∞",
        _ => "üå±"
    };

    private void NavigateToEditBook(Guid bookId) => Navigation.NavigateTo($"/books/{bookId}/edit");

    // ===== Wishlist Tab Methods =====

    private async Task SwitchTab(string tab)
    {
        activeTab = tab;
        if (tab == "wishlist")
        {
            await WishlistVM.LoadCommand.ExecuteAsync(null);
        }
        else if (tab == "shelves")
        {
            _jsInitialized = false;
        }
    }

    private System.Timers.Timer? _wishlistSearchTimer;

    private void HandleWishlistSearchInput(ChangeEventArgs e)
    {
        WishlistVM.SearchQuery = e.Value?.ToString() ?? "";

        _wishlistSearchTimer?.Stop();
        _wishlistSearchTimer?.Dispose();
        _wishlistSearchTimer = new System.Timers.Timer(300);
        _wishlistSearchTimer.Elapsed += async (sender, args) =>
        {
            _wishlistSearchTimer?.Stop();
            try
            {
                await InvokeAsync(async () =>
                {
                    await WishlistVM.SearchCommand.ExecuteAsync(null);
                    StateHasChanged();
                });
            }
            catch (ObjectDisposedException) { }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Wishlist search failed: {ex.Message}");
            }
        };
        _wishlistSearchTimer.Start();
    }

    private async Task HandleWishlistSort(ChangeEventArgs e)
    {
        WishlistVM.SortBy = e.Value?.ToString() ?? "DateAdded";
        await WishlistVM.SortCommand.ExecuteAsync(null);
    }

    private async Task HandleRemoveFromWishlist(Guid bookId)
    {
        await WishlistVM.RemoveFromWishlistCommand.ExecuteAsync(bookId);
        StateHasChanged();
    }

    private void OpenAddToWishlistModal()
    {
        WishlistVM.ClearAddForm();

        _activeBackHandler = async () =>
        {
            CloseAddToWishlistModal();
            return true;
        };
        BackButtonService.Register(_activeBackHandler);

        showAddToWishlistModal = true;
    }

    private void CloseAddToWishlistModal()
    {
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
        showAddToWishlistModal = false;
    }

    private async Task ScanWishlistIsbnAsync()
    {
        var isbn = await ScannerService.ScanBarcodeAsync();
        if (!string.IsNullOrEmpty(isbn))
        {
            WishlistVM.NewIsbn = isbn;
            await WishlistVM.LookupByIsbnCommand.ExecuteAsync(null);
            StateHasChanged();
        }
    }

    private async Task HandleWishlistLookup()
    {
        await WishlistVM.LookupByIsbnCommand.ExecuteAsync(null);
        StateHasChanged();
    }

    private async Task HandleAddToWishlist()
    {
        await WishlistVM.AddToWishlistCommand.ExecuteAsync(null);
        CloseAddToWishlistModal();
        StateHasChanged();
    }
}
