@page "/"
@page "/bookshelf"
@using BookLoggerApp.Core.ViewModels
@using BookLoggerApp.Core.Models
@using BookLoggerApp.Core.Enums
@using BookLoggerApp.Core.Services.Abstractions
@using BookLoggerApp.Components.Shared
@inject BookshelfViewModel ViewModel
@inject Microsoft.AspNetCore.Components.NavigationManager Navigation
@inject IGoalService GoalService
@inject BookLoggerApp.Core.Services.Abstractions.IBackButtonService BackButtonService
@implements IDisposable

<PageTitle>Bookshelf - BookLogger</PageTitle>

<div class="bookshelf-container">
    <!-- Reading Goal Header -->
    <GoalHeader TbrCount="@ViewModel.TbrCount"
                GoalTarget="@ViewModel.GoalTarget"
                BooksRead="@ViewModel.BooksReadThisYear"
                BooksRemaining="@ViewModel.BooksRemainingToGoal" />

    <!-- Header & Controls -->
    <div class="bookshelf-header">
        <h1>üìö My Bookshelf</h1>
        <div class="bookshelf-controls">
            <input type="text" class="search-input" placeholder="üîç Search books..."
                   @bind="ViewModel.SearchQuery" @bind:event="oninput" @onchange="HandleSearch" />
        </div>
    </div>

    <!-- Filters & Sort (Collapsible) -->
    <div class="bookshelf-filters-wrapper">
        <button class="filter-toggle-btn" @onclick="ToggleFilters">
            <span>@(filtersExpanded ? "‚ñº" : "‚ñ∂") Filters & Sort</span>
            @if (HasActiveFilters())
            {
                <span class="active-filter-badge">Active</span>
            }
        </button>

        <div class="bookshelf-filters @(filtersExpanded ? "expanded" : "collapsed")">
            <!-- Existing filters... -->
             <div class="filter-group">
                <label>Sort by:</label>
                <select value="@ViewModel.SortBy" @onchange="@((ChangeEventArgs e) => { ViewModel.SortBy = e.Value?.ToString() ?? "Title"; HandleSearch(); })">
                    <option value="Title">Title</option>
                    <option value="Author">Author</option>
                    <option value="DateAdded">Date Added</option>
                    <option value="Status">Status</option>
                </select>
            </div>
            <!-- ... (Keeping filters simple for now, as search clears shelves) -->
             <div class="filter-group">
                <button class="btn btn-secondary" @onclick="HandleClearFilters">Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Book Grid / Shelves -->
    @if (ViewModel.IsBusy)
    {
        <div class="loading">Loading your books...</div>
    }
    else if (!string.IsNullOrEmpty(ViewModel.SearchQuery) || ViewModel.FilterStatus.HasValue || ViewModel.FilterGenreId.HasValue)
    {
        <!-- Search Results View (Flat Grid) -->
        <div class="search-results-label">Search Results: @ViewModel.Books.Count book(s)</div>
        <div class="book-grid">
             <div class="shelf-row">
                @foreach (var book in ViewModel.Books)
                {
                    <div class="shelf-slot">
                        <BookCard Book="@book"
                                  IsInBookshelf="true"
                                  IsDraggable="true"
                                  OnClick="() => HandleBookClick(book)"
                                  OnDragStart="() => HandleDragStartBook(book.Id)"
                                  OnDelete="() => HandleDeleteBook(book.Id)" />
                    </div>
                }
             </div>
        </div>
    }
    else
    {
        <!-- Shelves View -->
        <div class="shelves-container">
            @foreach (var shelfVM in ViewModel.Shelves)
            {
                <div class="shelf-section @(draggedBookId.HasValue ? "drag-target" : "") @(shelfVM.IsExpanded ? "" : "collapsed")" 
                     @ondragenter="@(() => { /* Visual feedback handling in CSS */ })"
                     @ondragover:preventDefault
                     @ondrop="@(() => HandleDropOnShelf(shelfVM.Shelf.Id))">
                    
                    <div class="shelf-header">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="btn-icon toggle-icon @(shelfVM.IsExpanded ? "" : "collapsed")" 
                                    @onclick="() => shelfVM.IsExpanded = !shelfVM.IsExpanded">
                                ‚ñº
                            </button>
                            <h3>@shelfVM.Shelf.Name</h3>
                            <!-- Icon removed as requested -->
                        </div>
                        
                        <div class="shelf-actions">
                             @if (shelfVM.Shelf.SortOrder > 0) 
                             {
                                 <button class="btn-icon" @onclick="() => HandleDeleteShelf(shelfVM.Shelf.Id)" title="Delete Shelf">üóëÔ∏è</button>
                             }
                        </div>
                    </div>

                    @if (shelfVM.IsExpanded)
                    {
                        <div class="shelf-books">
                            <!-- Books -->
                            @foreach (var book in shelfVM.Books)
                            {
                                 <div class="shelf-slot">
                                    <BookCard Book="@book"
                                              IsInBookshelf="true"
                                              IsDraggable="true"
                                              OnClick="() => HandleBookClick(book)"
                                              OnDragStart="() => HandleDragStartBook(book.Id)"
                                              OnDelete="() => HandleRemoveBookFromShelf(book.Id, shelfVM.Shelf.Id)" />
                                </div>
                            }
                            
                            <!-- Plants (First shelf only for compatibility) -->
                            @if (shelfVM == ViewModel.Shelves.FirstOrDefault())
                            {
                                @foreach (var plant in ViewModel.BookshelfPlants)
                                {
                                    <div class="shelf-slot">
                                        <PlantCard Plant="@plant"
                                                   IsInBookshelf="true"
                                                   IsDraggable="false" 
                                                   OnClick="() => HandlePlantClick(plant)" 
                                                   OnRemove="() => HandleRemovePlant(plant.Id)" />
                                    </div>
                                }
                                 @if (ViewModel.AvailablePlants.Any())
                                 {
                                     <div class="empty-slot" @onclick="() => HandleAddPlant(0)">
                                        <div class="empty-slot-icon">üå±</div>
                                        <div class="empty-slot-text">Add Plant</div>
                                    </div>
                                 }
                            }
                        </div>
                        <div class="shelf-wood-base"></div>
                    }
                </div>
            }
        </div>
    }
    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <button class="fab-button secondary" @onclick="OpenAddShelfModal" title="New Shelf">
            üìö
        </button>
        <button class="fab-button" @onclick="NavigateToAddBook" title="Add Book">
            +
        </button>
    </div>
</div>

<!-- Add Shelf Modal -->
@if (showAddShelfModal)
{
    <div class="modal-overlay" @onclick="CloseAddShelfModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Add New Bookshelf</h3>
            <div class="form-group">
                <label>Name</label>
                <input type="text" @bind="newShelfName" class="form-control" placeholder="e.g. Favorites, TBR..." />
            </div>
            <div class="form-group">
                <label>Auto-Sort Rule</label>
                <select @bind="newShelfRule" class="form-control">
                    <option value="@ShelfAutoSortRule.None">Manual (Drag & Drop)</option>
                    <option value="@ShelfAutoSortRule.StatusPlanned">Planned (TBR)</option>
                    <option value="@ShelfAutoSortRule.StatusReading">Currently Reading</option>
                    <option value="@ShelfAutoSortRule.StatusCompleted">Read / Completed</option>
                </select>
                <small>Auto-sort shelves automatically include books matching the status.</small>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="CloseAddShelfModal">Cancel</button>
                <button class="btn btn-primary" @onclick="CreateShelf">Create Shelf</button>
            </div>
        </div>
    </div>
}

<!-- ... Plant/Book Modals (Keep existing ones) ... -->
<!-- Plant Detail Modal -->
@if (showPlantDetail && selectedPlant != null)
{
    <div class="purchase-modal-overlay" @onclick="ClosePlantDetail">
        <div class="purchase-modal plant-detail-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>üå± @selectedPlant.Name</h2>
                <button class="btn-close" @onclick="ClosePlantDetail">√ó</button>
            </div>
            <div class="modal-body">
                <PlantWidget Plant="@selectedPlant"
                             OnWater="HandleWaterPlantFromModal"
                             OnDelete="HandleDeletePlantFromModal"
                             IsWatering="@isWateringPlant" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="ClosePlantDetail">Close</button>
            </div>
        </div>
    </div>
}

<!-- Plant Selector Modal -->
@if (showPlantSelector)
{
    <div class="modal-overlay" @onclick="ClosePlantSelector">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Select a Plant</h3>
            <div class="plant-selector-grid" style="display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 0;">
                @if (ViewModel.AvailablePlants.Any())
                {
                    @foreach (var plant in ViewModel.AvailablePlants)
                    {
                        <div class="plant-select-item" @onclick="() => SelectPlantForBookshelf(plant)" style="cursor: pointer; transform: scale(0.9);">
                            <PlantCard Plant="@plant" IsInBookshelf="false" IsDraggable="false" />
                        </div>
                    }
                }
                else
                {
                    <p style="color: #ccc; width: 100%; text-align: center;">No plants available. Visit the shop?</p>
                    <button class="btn btn-primary" @onclick="@(() => Navigation.NavigateTo("/shop"))" style="width: 100%;">Go to Shop</button>
                }
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="ClosePlantSelector">Cancel</button>
            </div>
        </div>
    </div>
}
<!-- Delete Shelf Confirmation Modal -->
@if (showDeleteShelfModal)
{
    <div class="modal-overlay" @onclick="CloseDeleteShelfModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Delete Shelf</h3>
            <p>Are you sure you want to delete this shelf? Books will remain in your library.</p>
            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="CloseDeleteShelfModal">Cancel</button>
                <button class="btn btn-danger" @onclick="ConfirmDeleteShelf">Delete</button>
            </div>
        </div>
    </div>
}

@code {
    private bool filtersExpanded = false;
    private bool showAddShelfModal = false;
    private string newShelfName = "";
    private ShelfAutoSortRule newShelfRule = ShelfAutoSortRule.None;

    private Guid? draggedBookId;
    
    // Plant state
    private bool showPlantDetail;
    private UserPlant? selectedPlant;
    private bool isWateringPlant;



    // Back handler
    private Func<Task<bool>>? _activeBackHandler;

    protected override async Task OnInitializedAsync()
    {
        GoalService.GoalsChanged += OnGoalsChanged;
        await ViewModel.LoadCommand.ExecuteAsync(null);
    }

    private async void OnGoalsChanged(object? sender, EventArgs e)
    {
        await InvokeAsync(async () =>
        {
            await ViewModel.LoadCommand.ExecuteAsync(null);
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        GoalService.GoalsChanged -= OnGoalsChanged;
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
    }

    private void ToggleFilters() => filtersExpanded = !filtersExpanded;
    private bool HasActiveFilters() => ViewModel.FilterStatus.HasValue || ViewModel.FilterGenreId.HasValue || !string.IsNullOrWhiteSpace(ViewModel.SearchQuery);
    private void HandleSearch() => ViewModel.SearchCommand.ExecuteAsync(null);
    private async Task HandleClearFilters() { ViewModel.ClearFiltersCommand.Execute(null); await ViewModel.LoadCommand.ExecuteAsync(null); }
    private void NavigateToAddBook() => Navigation.NavigateTo("/books/new");
    private void HandleBookClick(Book book) => Navigation.NavigateTo($"/books/{book.Id}");

    // Shelf Logic
    private void OpenAddShelfModal()
    {
        newShelfName = "";
        newShelfRule = ShelfAutoSortRule.None;
        
        // Register back handler
        _activeBackHandler = async () => 
        { 
            CloseAddShelfModal(); 
            return true; 
        };
        BackButtonService.Register(_activeBackHandler);
        
        showAddShelfModal = true;
    }

    private void CloseAddShelfModal() 
    {
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
        showAddShelfModal = false;
    }

    private async Task CreateShelf()
    {
        if (string.IsNullOrWhiteSpace(newShelfName)) return;
        await ViewModel.CreateShelfCommand.ExecuteAsync((newShelfName, newShelfRule));
        CloseAddShelfModal();
    }

    private Guid? shelfToDeleteId;
    private bool showDeleteShelfModal;

    private void HandleDeleteShelf(Guid shelfId)
    {
        shelfToDeleteId = shelfId;
        
        // Register back handler
        _activeBackHandler = async () => 
        { 
            CloseDeleteShelfModal(); 
            return true; 
        };
        BackButtonService.Register(_activeBackHandler);
        
        showDeleteShelfModal = true;
    }

    private void CloseDeleteShelfModal()
    {
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
        showDeleteShelfModal = false;
        shelfToDeleteId = null;
    }

    private async Task ConfirmDeleteShelf()
    {
        if (shelfToDeleteId.HasValue)
        {
            await ViewModel.DeleteShelfCommand.ExecuteAsync(shelfToDeleteId.Value);
            CloseDeleteShelfModal();
        }
    }

    // Drag & Drop
    private void HandleDragStartBook(Guid bookId)
    {
        draggedBookId = bookId;
    }

    private async Task HandleDropOnShelf(Guid shelfId)
    {
        if (draggedBookId.HasValue)
        {
            // Add book to shelf
            await ViewModel.MoveBookToShelfAsync((draggedBookId.Value, shelfId));
            draggedBookId = null;
        }
    }

    private async Task HandleRemoveBookFromShelf(Guid bookId, Guid shelfId)
    {
         // On the shelf view, the 'delete' type action removes it from the shelf, not the library
         // Unless it's the AutoSort shelf? 
         // For manual shelves: Remove from shelf.
         // For AutoSort shelves: Can't really remove unless changing status.
         // Let's assume standard behavior is Remove from Shelf.
         
         await ViewModel.RemoveBookFromShelfCommand.ExecuteAsync((bookId, shelfId));
    }
    
    private void HandleDeleteBook(Guid bookId)
    {
        // For search results view, delete permanently
         ViewModel.DeleteBookCommand.ExecuteAsync(bookId);
    }

    // Plant stubs
    private void HandlePlantClick(UserPlant plant) 
    {
        selectedPlant = plant;
        
        // Register back handler
        _activeBackHandler = async () => 
        { 
            ClosePlantDetail(); 
            return true; 
        };
        BackButtonService.Register(_activeBackHandler);
        
        showPlantDetail = true;
    }
    private void ClosePlantDetail() 
    { 
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
        showPlantDetail = false; 
        selectedPlant = null; 
    }
    private async Task HandleWaterPlantFromModal() { if (selectedPlant != null) await ViewModel.WaterPlantCommand.ExecuteAsync(selectedPlant.Id); }
    private async Task HandleDeletePlantFromModal() { if (selectedPlant != null) { await ViewModel.DeletePlantCommand.ExecuteAsync(selectedPlant.Id); ClosePlantDetail(); } }
    private async Task HandleRemovePlant(Guid plantId) => await ViewModel.RemovePlantFromBookshelfCommand.ExecuteAsync(plantId);
    private bool showPlantSelector;
    
    private void HandleAddPlant(int pos) 
    { 
         // Register back handler
        _activeBackHandler = async () => 
        { 
            ClosePlantSelector(); 
            return true; 
        };
        BackButtonService.Register(_activeBackHandler);
        
         showPlantSelector = true;
    }

    private void ClosePlantSelector() 
    {
        if (_activeBackHandler != null)
        {
            BackButtonService.Unregister(_activeBackHandler);
            _activeBackHandler = null;
        }
        showPlantSelector = false;
    }

    private async Task SelectPlantForBookshelf(UserPlant plant)
    {
        // 0 implies append, or we could track specific position if needed
        await ViewModel.PlacePlantInBookshelfAsync((plant.Id, "0"));
        ClosePlantSelector();
    }

    private string GetPlantStatusIcon(PlantStatus status) => status switch { PlantStatus.Healthy => "üòä", PlantStatus.Thirsty => "üò∞", _ => "üå±" };
}
