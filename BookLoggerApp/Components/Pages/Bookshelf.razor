@page "/"
@page "/bookshelf"
@using BookLoggerApp.Core.ViewModels
@using BookLoggerApp.Core.Models
@using BookLoggerApp.Core.Enums
@using BookLoggerApp.Core.Services.Abstractions
@using BookLoggerApp.Components.Shared
@inject BookshelfViewModel ViewModel
@inject Microsoft.AspNetCore.Components.NavigationManager Navigation
@inject IGoalService GoalService
@implements IDisposable

<PageTitle>Bookshelf - BookLogger</PageTitle>

<div class="bookshelf-container">
    <!-- Reading Goal Header -->
    <GoalHeader TbrCount="@ViewModel.TbrCount"
                GoalTarget="@ViewModel.GoalTarget"
                BooksRead="@ViewModel.BooksReadThisYear"
                BooksRemaining="@ViewModel.BooksRemainingToGoal" />

    <!-- Header & Controls -->
    <div class="bookshelf-header">
        <h1>üìö My Bookshelf</h1>
        <div class="bookshelf-controls">
            <input type="text" class="search-input" placeholder="üîç Search books..."
                   @bind="ViewModel.SearchQuery" @bind:event="oninput" @onchange="HandleSearch" />
            <button class="btn btn-secondary" @onclick="OpenAddShelfModal">+ New Shelf</button>
            <button class="btn btn-primary" @onclick="NavigateToAddBook">+ Add Book</button>
        </div>
    </div>

    <!-- Filters & Sort (Collapsible) -->
    <div class="bookshelf-filters-wrapper">
        <button class="filter-toggle-btn" @onclick="ToggleFilters">
            <span>@(filtersExpanded ? "‚ñº" : "‚ñ∂") Filters & Sort</span>
            @if (HasActiveFilters())
            {
                <span class="active-filter-badge">Active</span>
            }
        </button>

        <div class="bookshelf-filters @(filtersExpanded ? "expanded" : "collapsed")">
            <!-- Existing filters... -->
             <div class="filter-group">
                <label>Sort by:</label>
                <select value="@ViewModel.SortBy" @onchange="@((ChangeEventArgs e) => { ViewModel.SortBy = e.Value?.ToString() ?? "Title"; HandleSearch(); })">
                    <option value="Title">Title</option>
                    <option value="Author">Author</option>
                    <option value="DateAdded">Date Added</option>
                    <option value="Status">Status</option>
                </select>
            </div>
            <!-- ... (Keeping filters simple for now, as search clears shelves) -->
             <div class="filter-group">
                <button class="btn btn-secondary" @onclick="HandleClearFilters">Clear Filters</button>
            </div>
        </div>
    </div>

    <!-- Book Grid / Shelves -->
    @if (ViewModel.IsBusy)
    {
        <div class="loading">Loading your books...</div>
    }
    else if (!string.IsNullOrEmpty(ViewModel.SearchQuery) || ViewModel.FilterStatus.HasValue || ViewModel.FilterGenreId.HasValue)
    {
        <!-- Search Results View (Flat Grid) -->
        <div class="search-results-label">Search Results: @ViewModel.Books.Count book(s)</div>
        <div class="book-grid">
             <div class="shelf-row">
                @foreach (var book in ViewModel.Books)
                {
                    <div class="shelf-slot">
                        <BookCard Book="@book"
                                  IsInBookshelf="true"
                                  IsDraggable="true"
                                  OnClick="() => HandleBookClick(book)"
                                  OnDragStart="() => HandleDragStartBook(book.Id)"
                                  OnDelete="() => HandleDeleteBook(book.Id)" />
                    </div>
                }
             </div>
        </div>
    }
    else
    {
        <!-- Shelves View -->
        <div class="shelves-container">
            @foreach (var shelfVM in ViewModel.Shelves)
            {
                <div class="shelf-component" @ondrop="() => HandleDropOnShelf(shelfVM.Shelf.Id)" 
                     @ondragover:preventDefault="true" @ondragover="() => {}">
                    
                    <div class="shelf-header-row">
                        <h3>@shelfVM.Shelf.Icon @shelfVM.Shelf.Name</h3>
                        @if (shelfVM.Shelf.AutoSortRule != ShelfAutoSortRule.None)
                        {
                            <span class="badge badge-info">Auto: @shelfVM.Shelf.AutoSortRule</span>
                        }
                        
                        <div class="shelf-actions">
                             @if (shelfVM.Shelf.SortOrder > 0) 
                             {
                                 <!-- Delete only non-default if needed, strict delete for now -->
                                 <button class="btn-icon" @onclick="() => HandleDeleteShelf(shelfVM.Shelf.Id)" title="Delete Shelf">üóëÔ∏è</button>
                             }
                        </div>
                    </div>

                    <div class="shelf-books-row">
                        <!-- Books -->
                        @foreach (var book in shelfVM.Books)
                        {
                             <div class="shelf-slot">
                                <BookCard Book="@book"
                                          IsInBookshelf="true"
                                          IsDraggable="true"
                                          OnClick="() => HandleBookClick(book)"
                                          OnDragStart="() => HandleDragStartBook(book.Id)"
                                          OnDelete="() => HandleRemoveBookFromShelf(book.Id, shelfVM.Shelf.Id)" /> <!-- Changed delete to remove from shelf -->
                            </div>
                        }
                        
                        <!-- Plants (Only on first shelf or specific plant shelf? For now, keep plants separate or allow adding to any shelf via similar logic? 
                             The request is about Books. Let's put plants in a designated Plant Shelf or just the first one if we want to keep them.
                             Or just display them at the bottom in a 'Greenhouse' section? 
                             For back-compat, let's put them in the first shelf or a dedicated one.
                             Let's append plants to the first shelf for now if any exist. -->
                        @if (shelfVM == ViewModel.Shelves.FirstOrDefault())
                        {
                            @foreach (var plant in ViewModel.BookshelfPlants)
                            {
                                <div class="shelf-slot">
                                    <PlantCard Plant="@plant"
                                               IsInBookshelf="true"
                                               IsDraggable="false" 
                                               OnClick="() => HandlePlantClick(plant)" 
                                               OnRemove="() => HandleRemovePlant(plant.Id)" />
                                </div>
                            }
                            <!-- Add Plant Button -->
                             @if (ViewModel.AvailablePlants.Any())
                             {
                                 <div class="empty-slot" @onclick="() => HandleAddPlant(0)"> <!-- Position 0 implies append/generic -->
                                    <div class="empty-slot-icon">üå±</div>
                                    <div class="empty-slot-text">Add Plant</div>
                                </div>
                             }
                        }
                    </div>
                    <div class="shelf-wood-base"></div>
                </div>
            }
        </div>
    }
</div>

<!-- Add Shelf Modal -->
@if (showAddShelfModal)
{
    <div class="modal-overlay" @onclick="CloseAddShelfModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Add New Bookshelf</h3>
            <div class="form-group">
                <label>Name</label>
                <input type="text" @bind="newShelfName" class="form-control" placeholder="e.g. Favorites, TBR..." />
            </div>
            <div class="form-group">
                <label>Auto-Sort Rule</label>
                <select @bind="newShelfRule" class="form-control">
                    <option value="@ShelfAutoSortRule.None">Manual (Drag & Drop)</option>
                    <option value="@ShelfAutoSortRule.StatusPlanned">Planned (TBR)</option>
                    <option value="@ShelfAutoSortRule.StatusReading">Currently Reading</option>
                    <option value="@ShelfAutoSortRule.StatusCompleted">Read / Completed</option>
                </select>
                <small>Auto-sort shelves automatically include books matching the status.</small>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" @onclick="CloseAddShelfModal">Cancel</button>
                <button class="btn btn-primary" @onclick="CreateShelf">Create Shelf</button>
            </div>
        </div>
    </div>
}

<!-- ... Plant/Book Modals (Keep existing ones) ... -->
<!-- Plant Detail Modal -->
@if (showPlantDetail && selectedPlant != null)
{
    <div class="purchase-modal-overlay" @onclick="ClosePlantDetail">
        <div class="purchase-modal plant-detail-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>üå± @selectedPlant.Name</h2>
                <button class="btn-close" @onclick="ClosePlantDetail">√ó</button>
            </div>
            <div class="modal-body">
                <PlantWidget Plant="@selectedPlant"
                             OnWater="HandleWaterPlantFromModal"
                             OnDelete="HandleDeletePlantFromModal"
                             IsWatering="@isWateringPlant" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="ClosePlantDetail">Close</button>
            </div>
        </div>
    </div>
}

@code {
    private bool filtersExpanded = false;
    private bool showAddShelfModal = false;
    private string newShelfName = "";
    private ShelfAutoSortRule newShelfRule = ShelfAutoSortRule.None;

    private Guid? draggedBookId;
    
    // Plant state
    private bool showPlantDetail;
    private UserPlant? selectedPlant;
    private bool isWateringPlant;


    protected override async Task OnInitializedAsync()
    {
        GoalService.GoalsChanged += OnGoalsChanged;
        await ViewModel.LoadCommand.ExecuteAsync(null);
    }

    private async void OnGoalsChanged(object? sender, EventArgs e)
    {
        await InvokeAsync(async () =>
        {
            await ViewModel.LoadCommand.ExecuteAsync(null);
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        GoalService.GoalsChanged -= OnGoalsChanged;
    }

    private void ToggleFilters() => filtersExpanded = !filtersExpanded;
    private bool HasActiveFilters() => ViewModel.FilterStatus.HasValue || ViewModel.FilterGenreId.HasValue || !string.IsNullOrWhiteSpace(ViewModel.SearchQuery);
    private void HandleSearch() => ViewModel.SearchCommand.ExecuteAsync(null);
    private async Task HandleClearFilters() { ViewModel.ClearFiltersCommand.Execute(null); await ViewModel.LoadCommand.ExecuteAsync(null); }
    private void NavigateToAddBook() => Navigation.NavigateTo("/books/new");
    private void HandleBookClick(Book book) => Navigation.NavigateTo($"/books/{book.Id}");

    // Shelf Logic
    private void OpenAddShelfModal()
    {
        newShelfName = "";
        newShelfRule = ShelfAutoSortRule.None;
        showAddShelfModal = true;
    }

    private void CloseAddShelfModal() => showAddShelfModal = false;

    private async Task CreateShelf()
    {
        if (string.IsNullOrWhiteSpace(newShelfName)) return;
        await ViewModel.CreateShelfCommand.ExecuteAsync((newShelfName, newShelfRule));
        CloseAddShelfModal();
    }

    private async Task HandleDeleteShelf(Guid shelfId)
    {
        if (await App.Current!.MainPage!.DisplayAlert("Delete Shelf", "Are you sure? Books will remain in your library.", "Delete", "Cancel"))
        {
             await ViewModel.DeleteShelfCommand.ExecuteAsync(shelfId);
        }
    }

    // Drag & Drop
    private void HandleDragStartBook(Guid bookId)
    {
        draggedBookId = bookId;
    }

    private async Task HandleDropOnShelf(Guid shelfId)
    {
        if (draggedBookId.HasValue)
        {
            // Add book to shelf
            await ViewModel.MoveBookToShelfAsync((draggedBookId.Value, shelfId));
            draggedBookId = null;
        }
    }

    private async Task HandleRemoveBookFromShelf(Guid bookId, Guid shelfId)
    {
         // On the shelf view, the 'delete' type action removes it from the shelf, not the library
         // Unless it's the AutoSort shelf? 
         // For manual shelves: Remove from shelf.
         // For AutoSort shelves: Can't really remove unless changing status.
         // Let's assume standard behavior is Remove from Shelf.
         
         await ViewModel.RemoveBookFromShelfCommand.ExecuteAsync((bookId, shelfId));
    }
    
    private void HandleDeleteBook(Guid bookId)
    {
        // For search results view, delete permanently
         ViewModel.DeleteBookCommand.ExecuteAsync(bookId);
    }

    // Plant stubs
    private void HandlePlantClick(UserPlant plant) 
    {
        selectedPlant = plant;
        showPlantDetail = true;
    }
    private void ClosePlantDetail() { showPlantDetail = false; selectedPlant = null; }
    private async Task HandleWaterPlantFromModal() { if (selectedPlant != null) await ViewModel.WaterPlantCommand.ExecuteAsync(selectedPlant.Id); }
    private async Task HandleDeletePlantFromModal() { if (selectedPlant != null) { await ViewModel.DeletePlantCommand.ExecuteAsync(selectedPlant.Id); ClosePlantDetail(); } }
    private async Task HandleRemovePlant(Guid plantId) => await ViewModel.RemovePlantFromBookshelfCommand.ExecuteAsync(plantId);
    private void HandleAddPlant(int pos) 
    { 
         // Logic to add plant logic (omitted for brevity as focus is shelves)
         Navigation.NavigateTo("/shop"); // Or open selector
    }

    private string GetPlantStatusIcon(PlantStatus status) => status switch { PlantStatus.Healthy => "üòä", PlantStatus.Thirsty => "üò∞", _ => "üå±" };
}
