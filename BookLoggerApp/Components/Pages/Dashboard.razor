@page "/dashboard"
@using BookLoggerApp.Core.ViewModels
@using BookLoggerApp.Core.Models
@using BookLoggerApp.Core.Services.Abstractions
@inject DashboardViewModel ViewModel
@inject Microsoft.AspNetCore.Components.NavigationManager Navigation
@inject IGoalService GoalService
@inject IImageService ImageService
@implements IDisposable

<PageTitle>Dashboard - BookLogger</PageTitle>

<div class="dashboard-container">
    @if (ViewModel.IsBusy)
    {
        <div class="loading-spinner">
            <p>Loading...</p>
        </div>
    }
    else if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
    {
        <div class="alert alert-danger">
            @ViewModel.ErrorMessage
        </div>
    }
    else
    {
        <!-- Currently Reading Section -->
        <section class="currently-reading">
            <h2>Currently Reading</h2>
            @if (ViewModel.CurrentlyReading != null)
            {
                <div class="book-card-large">
                    @if (!string.IsNullOrEmpty(_coverImageDataUrl))
                    {
                        <img src="@_coverImageDataUrl" alt="Book Cover" class="book-cover" />
                    }
                    <div class="book-info">
                        <h3>@ViewModel.CurrentlyReading.Title</h3>
                        <p class="author">by @ViewModel.CurrentlyReading.Author</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: @ViewModel.CurrentlyReading.ProgressPercentage%"></div>
                        </div>
                        <p class="progress-text">Page @ViewModel.CurrentlyReading.CurrentPage / @(ViewModel.CurrentlyReading.PageCount ?? 0) (@ViewModel.CurrentlyReading.ProgressPercentage%)</p>
                        <button class="btn btn-primary" @onclick="NavigateToContinueReading">Continue Reading ‚Üí</button>
                    </div>
                </div>
            }
            else
            {
                <p>No book currently reading. <a href="/bookshelf">Browse your bookshelf</a></p>
            }
        </section>

        <!-- This Week Stats - Compact Chips -->
        <section class="stats-chips">
            <span class="stat-chip">
                <span class="stat-chip-icon">üìö</span>
                <span class="stat-chip-value">@ViewModel.BooksReadThisWeek</span>
                <span class="stat-chip-label">books</span>
            </span>
            <span class="stat-chip">
                <span class="stat-chip-icon">‚è±Ô∏è</span>
                <span class="stat-chip-value">@FormatMinutes(ViewModel.MinutesReadThisWeek)</span>
            </span>
            <span class="stat-chip">
                <span class="stat-chip-icon">üìÑ</span>
                <span class="stat-chip-value">@ViewModel.PagesReadThisWeek</span>
                <span class="stat-chip-label">pages</span>
            </span>
            <span class="stat-chip">
                <span class="stat-chip-icon">‚≠ê</span>
                <span class="stat-chip-value">@ViewModel.XpEarnedThisWeek</span>
                <span class="stat-chip-label">XP</span>
            </span>
        </section>

        <!-- Active Goals -->
        <section class="goals-section">
            <h2>Active Goals</h2>
            @if (ViewModel.ActiveGoals.Any())
            {
                <div class="goals-list">
                    @foreach (var goal in ViewModel.ActiveGoals)
                    {
                        <GoalCard Goal="@goal" />
                    }
                </div>
            }
            else
            {
                <p>No active goals. <a href="/goals">Create a goal</a></p>
            }
        </section>

        <!-- Plant Widget -->
        @if (ViewModel.ActivePlant != null)
        {
            <section class="plant-widget-section">
                <PlantWidget Plant="@ViewModel.ActivePlant" OnWater="HandleWaterPlant" />
            </section>
        }

        <!-- Recent Activity -->
        <section class="recent-activity">
            <h2>Recent Activity</h2>
            @if (ViewModel.RecentActivity.Any())
            {
                <ul class="activity-list">
                    @foreach (var session in ViewModel.RecentActivity)
                    {
                        <li>
                            <span class="activity-icon">üìñ</span>
                            <span class="activity-text">Read for @session.Minutes minutes</span>
                            <span class="activity-time">@FormatRelativeTime(session.StartedAt)</span>
                        </li>
                    }
                </ul>
            }
            else
            {
                <p>No recent activity.</p>
            }
        </section>
    }
</div>

@code {
    private string? _coverImageDataUrl;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to goal changes to refresh data when sessions end
        GoalService.GoalsChanged += OnGoalsChanged;

        try
        {
            await ViewModel.LoadCommand.ExecuteAsync(null);
            await LoadCoverImageAsync();
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"=== EXCEPTION IN DASHBOARD OnInitializedAsync ===");
            System.Diagnostics.Debug.WriteLine($"Exception Type: {ex.GetType().FullName}");
            System.Diagnostics.Debug.WriteLine($"Message: {ex.Message}");
            System.Diagnostics.Debug.WriteLine($"Stack trace: {ex.StackTrace}");
            if (ex.InnerException != null)
            {
                System.Diagnostics.Debug.WriteLine($"Inner Exception: {ex.InnerException.GetType().FullName}");
                System.Diagnostics.Debug.WriteLine($"Inner Message: {ex.InnerException.Message}");
            }
            System.Diagnostics.Debug.WriteLine("=== END EXCEPTION ===");
            // Don't throw - let the UI render with error message
        }
    }

    private async void OnGoalsChanged(object? sender, EventArgs e)
    {
        // Reload dashboard data when goals change
        await InvokeAsync(async () =>
        {
            await ViewModel.LoadCommand.ExecuteAsync(null);
            await LoadCoverImageAsync();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        GoalService.GoalsChanged -= OnGoalsChanged;
    }

    private async Task LoadCoverImageAsync()
    {
        _coverImageDataUrl = null;

        if (ViewModel.CurrentlyReading == null || string.IsNullOrEmpty(ViewModel.CurrentlyReading.CoverImagePath))
            return;

        try
        {
            var coverPath = ViewModel.CurrentlyReading.CoverImagePath;

            // If it's already a URL (http/https), use it directly
            if (coverPath.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
                coverPath.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
            {
                _coverImageDataUrl = coverPath;
                return;
            }

            // Get the full path from ImageService
            var fullPath = await ImageService.GetCoverImagePathAsync(ViewModel.CurrentlyReading.Id);

            if (string.IsNullOrEmpty(fullPath) || !System.IO.File.Exists(fullPath))
                return;

            // Read the file and convert to Base64
            var imageBytes = await System.IO.File.ReadAllBytesAsync(fullPath);
            var base64 = Convert.ToBase64String(imageBytes);

            // Determine MIME type
            var mimeType = fullPath.EndsWith(".png", StringComparison.OrdinalIgnoreCase)
                ? "image/png"
                : "image/jpeg";

            _coverImageDataUrl = $"data:{mimeType};base64,{base64}";
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to load cover image: {ex.Message}");
            _coverImageDataUrl = null;
        }
    }

    private string FormatMinutes(int minutes)
    {
        if (minutes < 60) return $"{minutes}m";
        var hours = minutes / 60;
        var remainingMinutes = minutes % 60;
        return $"{hours}h {remainingMinutes}m";
    }

    private string FormatRelativeTime(DateTime dateTime)
    {
        var diff = DateTime.UtcNow - dateTime;
        if (diff.TotalMinutes < 60) return $"{(int)diff.TotalMinutes} minutes ago";
        if (diff.TotalHours < 24) return $"{(int)diff.TotalHours} hours ago";
        return $"{(int)diff.TotalDays} days ago";
    }

    private void NavigateToContinueReading()
    {
        if (ViewModel.CurrentlyReading != null)
        {
            Navigation.NavigateTo($"/books/{ViewModel.CurrentlyReading.Id}");
        }
    }

    private async Task HandleWaterPlant()
    {
        await ViewModel.WaterPlantCommand.ExecuteAsync(null);
    }
}

