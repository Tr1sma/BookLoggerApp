@page "/books/{Id:guid}/edit"
@page "/books/new"
@using BookLoggerApp.Core.ViewModels
@using BookLoggerApp.Core.Models
@using BookLoggerApp.Components.Shared
@using BookLoggerApp.Core.Services.Abstractions
@using BookLoggerApp.Core.Helpers
@inject BookEditViewModel ViewModel
@inject NavigationManager Navigation
@inject IImageService ImageService
@inject BookLoggerApp.Core.Services.Abstractions.IBookService BookService
@inject BookLoggerApp.Core.Services.Abstractions.IStatsService StatsService
@inject BookLoggerApp.Services.IScannerService ScannerService

<PageTitle>@(ViewModel.Book?.Id == Guid.Empty ? "Add Book" : "Edit Book") - LoveLit</PageTitle>

<div class="book-edit-container">
    <div class="book-edit-header">
        <h1>@(ViewModel.Book?.Id == Guid.Empty ? "Add New Book" : "Edit Book")</h1>
        <button class="btn btn-secondary" @onclick="NavigateBack">‚Üê Back</button>
    </div>

    @if (ViewModel.IsBusy)
    {
        <div class="loading">Loading...</div>
    }
    else if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
    {
        <div class="alert alert-danger">@ViewModel.ErrorMessage</div>
    }
    else if (ViewModel.Book != null)
    {
        <form class="book-edit-form" @onsubmit="HandleSave" @onsubmit:preventDefault="true">
            <!-- Basic Information -->
            <section class="form-section">
                <h2>Basic Information</h2>
                
                <div class="form-group">
                    <label for="title">Title *</label>
                    <input id="title" type="text" @bind="ViewModel.Book.Title" required maxlength="500" />
                </div>

                <div class="form-group">
                    <label for="author">Author *</label>
                    <input id="author" type="text" @bind="ViewModel.Book.Author" required maxlength="300" />
                </div>

                <div class="form-group">
                    <label for="isbn">ISBN</label>
                    <div class="isbn-input-group">
                        <input id="isbn" type="text" @bind="ViewModel.Book.ISBN" maxlength="13" placeholder="Enter ISBN-10 or ISBN-13" />
                        <button type="button"
                                class="btn btn-success"
                                @onclick="ScanIsbnAsync">
                            üì∑ Scan
                        </button>
                        <button type="button"
                                class="btn btn-info"
                                @onclick="HandleIsbnLookup"
                                disabled="@(ViewModel.IsLookingUpIsbn || string.IsNullOrWhiteSpace(ViewModel.Book?.ISBN))">
                            @if (ViewModel.IsLookingUpIsbn)
                            {
                                <span>Loading...</span>
                            }
                            else
                            {
                                <span>üîç Auto-Fill</span>
                            }
                        </button>
                    </div>
                    @if (!string.IsNullOrEmpty(ViewModel.LookupMessage))
                    {
                        <div class="lookup-message @(ViewModel.LookupMessage.Contains("Error") || ViewModel.LookupMessage.Contains("No book") ? "error" : "success")">
                            @ViewModel.LookupMessage
                        </div>
                    }
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="publisher">Publisher</label>
                        <input id="publisher" type="text" @bind="ViewModel.Book!.Publisher" maxlength="200" />
                    </div>

                    <div class="form-group">
                        <label for="publicationYear">Publication Year</label>
                        <input id="publicationYear" type="number" @bind="ViewModel.Book!.PublicationYear" min="1000" max="@DateTime.Now.Year" />
                    </div>
                </div>

                <div class="form-group">
                    <label for="language">Language</label>
                    <input id="language" type="text" @bind="ViewModel.Book.Language" maxlength="50" placeholder="e.g., en, de" />
                </div>
            </section>

            <!-- Content -->
            <section class="form-section">
                <h2>Content</h2>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" @bind="ViewModel.Book.Description" maxlength="2000" rows="4"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="pageCount">Total Pages</label>
                        <input id="pageCount" type="number" @bind="ViewModel.Book.PageCount" min="1" />
                    </div>

                    <div class="form-group">
                        <label for="currentPage">Current Page</label>
                        <input id="currentPage" type="number" @bind="ViewModel.Book.CurrentPage" min="0" />
                    </div>
                </div>
            </section>

            <!-- Status -->
            <section class="form-section">
                <h2>Status</h2>

                <div class="form-group">
                    <label for="status">Reading Status</label>
                    <select id="status" @bind="ViewModel.Book.Status">
                        <option value="@ReadingStatus.Planned">Planned</option>
                        <option value="@ReadingStatus.Reading">Reading</option>
                        <option value="@ReadingStatus.Completed">Completed</option>
                        <option value="@ReadingStatus.Abandoned">Abandoned</option>
                    </select>
                </div>
            </section>

            <!-- Genres -->
            <section class="form-section">
                <h2>Genres</h2>
                
                <div class="genres-selection">
                    @foreach (var genre in ViewModel.AvailableGenres)
                    {
                        <label class="genre-checkbox">
                            <input type="checkbox" 
                                   checked="@ViewModel.SelectedGenreIds.Contains(genre.Id)"
                                   @onchange="@((ChangeEventArgs e) => ToggleGenre(genre.Id, e.Value as bool? ?? false))" />
                            <span>@genre.Icon @genre.Name</span>
                        </label>
                    }
                </div>
            </section>

            <!-- Tropes -->
            @if (ViewModel.AvailableTropes.Any())
            {
                <section class="form-section">
                    <h2>Tropes & Tags</h2>
                    <div class="form-hint">Select matching tropes based on your selected genres.</div>
                    
                    <div class="genres-selection">
                        @foreach (var trope in ViewModel.AvailableTropes)
                        {
                            <label class="genre-checkbox">
                                <input type="checkbox" 
                                       checked="@ViewModel.SelectedTropeIds.Contains(trope.Id)"
                                       @onchange="@((ChangeEventArgs e) => ToggleTrope(trope.Id, e.Value as bool? ?? false))" />
                                <span>@trope.Name</span>
                            </label>
                        }
                    </div>
                </section>
            }

            <!-- Shelves -->
            <section class="form-section">
                <h2>Shelves</h2>
                <div class="form-hint">Assign this book to manual shelves. Auto-sort shelves are populated automatically.</div>
                
                <div class="genres-selection"> <!-- Reusing genres style for grid layout -->
                    @if (ViewModel.AvailableShelves.Any())
                    {
                        @foreach (var shelf in ViewModel.AvailableShelves)
                        {
                            <label class="genre-checkbox">
                                <input type="checkbox" 
                                       checked="@ViewModel.SelectedShelfIds.Contains(shelf.Id)"
                                       @onchange="@((ChangeEventArgs e) => ToggleShelf(shelf.Id, e.Value as bool? ?? false))" />
                                <span>@shelf.Icon @shelf.Name</span>
                            </label>
                        }
                    }
                    else
                    {
                        <p>No manual shelves available. Create them on the Bookshelf page.</p>
                    }
                </div>
            </section>

            <!-- Cover Image -->
            <section class="form-section">
                <h2>Cover Image</h2>

                <div class="form-group">
                    <label for="coverImagePath">Cover Image URL/Path</label>
                    <input id="coverImagePath" type="text" @bind="ViewModel.Book.CoverImagePath" maxlength="500" placeholder="/images/covers/book.jpg" />

                    @if (!string.IsNullOrEmpty(_coverPreviewUrl))
                    {
                        <div class="cover-preview">
                            <img src="@_coverPreviewUrl" alt="Cover preview" onerror="this.style.display='none'" />
                        </div>
                    }
                </div>

                <div class="form-group">
                    <label>Book Spine Display</label>
                    <p class="form-hint">Choose how the book spine should be displayed in the bookshelf</p>

                    <div class="spine-mode-selector">
                        <button type="button"
                                class="spine-mode-option @(!ViewModel.Book.UsesCoverAsSpine ? "selected" : "")"
                                @onclick="() => SetSpineMode(false)">
                            <span class="spine-mode-icon">üé®</span>
                            <span class="spine-mode-label">Color</span>
                        </button>
                        <button type="button"
                                class="spine-mode-option @(ViewModel.Book.UsesCoverAsSpine ? "selected" : "") @(string.IsNullOrEmpty(_coverPreviewUrl) ? "disabled" : "")"
                                @onclick="() => SetSpineMode(true)"
                                disabled="@string.IsNullOrEmpty(_coverPreviewUrl)">
                            <span class="spine-mode-icon">üñºÔ∏è</span>
                            <span class="spine-mode-label">Cover</span>
                        </button>
                    </div>
                    @if (string.IsNullOrEmpty(_coverPreviewUrl))
                    {
                        <p class="form-hint-warning">Cover mode requires a cover image</p>
                    }
                </div>

                @if (!ViewModel.Book.UsesCoverAsSpine)
                {
                    <div class="form-group">
                        <label>Spine Color</label>
                        <div class="spine-color-picker">
                            @foreach (var color in GetSpineColors())
                            {
                                <button type="button"
                                        class="spine-color-option @(ViewModel.Book.SpineColor == color.Key ? "selected" : "")"
                                        style="background: linear-gradient(to right, #@color.Value.dark, #@color.Value.light, #@color.Value.dark);"
                                        @onclick="() => SetSpineColor(color.Key)"
                                        title="@color.Key">
                                </button>
                            }
                            
                            <!-- Custom Color Picker -->
                            <div class="custom-color-picker-container">
                                <label class="custom-color-label" title="Custom Color">
                                    <span class="spine-mode-icon">üé®</span>
                                    <span class="custom-text">Custom</span>
                                    <input type="color" 
                                           style="position: absolute; opacity: 0; width: 100%; height: 100%; top: 0; left: 0; padding: 0; margin: 0; border: none; cursor: pointer;"
                                           value="@GetCustomColorValue()" 
                                           @onchange="@(e => SetCustomSpineColor(e.Value?.ToString()))" />
                                </label>
                            </div>
                        </div>
                    </div>
                }
            </section>

            <!-- Form Actions -->
            <div class="form-actions">
                @if (ViewModel.Book.Id != Guid.Empty)
                {
                    <button type="button" class="btn btn-danger" @onclick="ShowDeleteModal">
                        L√∂schen
                    </button>
                }
                <button type="submit" class="btn btn-primary" disabled="@ViewModel.IsBusy">
                    @(ViewModel.Book.Id == Guid.Empty ? "Add Book" : "Save Changes")
                </button>
                <button type="button" class="btn btn-secondary" @onclick="NavigateBack">Cancel</button>
            </div>
        </form>
    }
</div>

<!-- Book Completion Celebration -->
<BookCompletionCelebration
    IsVisible="@ViewModel.ShowBookCompletionCelebration"
    Book="@ViewModel.Book"
    OnClose="HandleCelebrationClose" />

<!-- Delete Confirmation Modal -->
<DeleteConfirmationModal
    IsVisible="@ViewModel.ShowDeleteConfirmation"
    BookTitle="@ViewModel.Book?.Title"
    IsDeleting="@ViewModel.IsDeleting"
    OnConfirm="HandleDeleteConfirm"
    OnCancel="HideDeleteModal" />

@code {
    [Parameter] public Guid Id { get; set; }

    private string? _coverPreviewUrl;

    protected override async Task OnInitializedAsync()
    {
        Guid? bookId = Id != Guid.Empty ? Id : null;
        await ViewModel.LoadCommand.ExecuteAsync(bookId);
        await LoadCoverPreviewAsync();
    }

    private async Task LoadCoverPreviewAsync()
    {
        _coverPreviewUrl = null;

        if (ViewModel.Book == null || string.IsNullOrEmpty(ViewModel.Book.CoverImagePath))
            return;

        try
        {
            var coverPath = ViewModel.Book.CoverImagePath;

            // If it's already a URL (http/https), use it directly
            if (coverPath.StartsWith("http://", StringComparison.OrdinalIgnoreCase) ||
                coverPath.StartsWith("https://", StringComparison.OrdinalIgnoreCase))
            {
                _coverPreviewUrl = coverPath;
                return;
            }

            // If it's a data URL already, use it directly
            if (coverPath.StartsWith("data:", StringComparison.OrdinalIgnoreCase))
            {
                _coverPreviewUrl = coverPath;
                return;
            }

            // For local files, get the full path from ImageService
            if (ViewModel.Book.Id != Guid.Empty)
            {
                var fullPath = await ImageService.GetCoverImagePathAsync(ViewModel.Book.Id);

                if (string.IsNullOrEmpty(fullPath) || !System.IO.File.Exists(fullPath))
                    return;

                // Read the file and convert to Base64
                var imageBytes = await System.IO.File.ReadAllBytesAsync(fullPath);
                var base64 = Convert.ToBase64String(imageBytes);

                // Determine MIME type
                var mimeType = fullPath.EndsWith(".png", StringComparison.OrdinalIgnoreCase)
                    ? "image/png"
                    : "image/jpeg";

                _coverPreviewUrl = $"data:{mimeType};base64,{base64}";
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Failed to load cover preview: {ex.Message}");
            _coverPreviewUrl = null;
        }
    }

    private async Task HandleSave()
    {
        await ViewModel.SaveCommand.ExecuteAsync(null);
        if (string.IsNullOrEmpty(ViewModel.ErrorMessage) && ViewModel.Book != null)
        {
            // If book was completed, show celebration first before navigating
            if (ViewModel.ShowBookCompletionCelebration)
            {
                // Celebration will be shown, navigation happens in HandleCelebrationClose
                StateHasChanged();
            }
            else
            {
                Navigation.NavigateTo($"/books/{ViewModel.Book.Id}");
            }
        }
    }

    private void HandleCelebrationClose()
    {
        ViewModel.ShowBookCompletionCelebration = false;
        if (ViewModel.Book != null)
        {
            Navigation.NavigateTo($"/books/{ViewModel.Book.Id}");
        }
    }

    private void ShowDeleteModal()
    {
        ViewModel.ShowDeleteConfirmation = true;
    }

    private void HideDeleteModal()
    {
        ViewModel.ShowDeleteConfirmation = false;
    }

    private async Task HandleDeleteConfirm()
    {
        await ViewModel.DeleteBookCommand.ExecuteAsync(null);

        // If deletion was successful, navigate to bookshelf
        if (ViewModel.BookDeleted)
        {
            Navigation.NavigateTo("/bookshelf");
        }
    }

    private async Task ToggleGenre(Guid genreId, bool isSelected)
    {
        await ViewModel.ToggleGenreAsync(genreId, isSelected);
    }

    private void ToggleTrope(Guid tropeId, bool isSelected)
    {
        if (isSelected && !ViewModel.SelectedTropeIds.Contains(tropeId))
        {
            ViewModel.SelectedTropeIds.Add(tropeId);
        }
        else if (!isSelected && ViewModel.SelectedTropeIds.Contains(tropeId))
        {
            ViewModel.SelectedTropeIds.Remove(tropeId);
        }
    }

    private void ToggleShelf(Guid shelfId, bool isSelected)
    {
        if (isSelected && !ViewModel.SelectedShelfIds.Contains(shelfId))
        {
            ViewModel.SelectedShelfIds.Add(shelfId);
        }
        else if (!isSelected && ViewModel.SelectedShelfIds.Contains(shelfId))
        {
            ViewModel.SelectedShelfIds.Remove(shelfId);
        }
    }

    private void NavigateBack()
    {
        if (ViewModel.Book != null && ViewModel.Book.Id != Guid.Empty)
        {
            Navigation.NavigateTo($"/books/{ViewModel.Book.Id}");
        }
        else
        {
            Navigation.NavigateTo("/bookshelf");
        }
    }

    private async Task HandleIsbnLookup()
    {
        await ViewModel.LookupByIsbnCommand.ExecuteAsync(null);
        // Reload cover preview after lookup (might have set a new cover URL)
        await LoadCoverPreviewAsync();
        StateHasChanged();
    }

    private async Task ScanIsbnAsync()
    {
        var isbn = await ScannerService.ScanBarcodeAsync();
        if (!string.IsNullOrEmpty(isbn))
        {
            ViewModel.Book.ISBN = isbn;
            await HandleIsbnLookup();
        }
    }


    private IReadOnlyDictionary<string, (string dark, string light)> GetSpineColors()
    {
        return SpineColorHelper.Palette;
    }

    private void SetSpineColor(string color)
    {
        if (ViewModel.Book != null)
        {
            ViewModel.Book.SpineColor = color;
            ViewModel.Book.UsesCoverAsSpine = false;
        }
    }

    private void SetCustomSpineColor(string? colorCode)
    {
        if (ViewModel.Book != null && !string.IsNullOrEmpty(colorCode))
        {
            ViewModel.Book.SpineColor = colorCode;
            ViewModel.Book.UsesCoverAsSpine = false;
        }
    }

    private string GetCustomColorValue()
    {
        if (ViewModel.Book?.SpineColor != null && ViewModel.Book.SpineColor.StartsWith("#"))
        {
            return ViewModel.Book.SpineColor;
        }
        return "#000000"; // Default
    }

    private void SetSpineMode(bool useCoverAsSpine)
    {
        if (ViewModel.Book != null)
        {
            // Only allow cover mode if there's a cover image
            if (useCoverAsSpine && string.IsNullOrEmpty(_coverPreviewUrl))
                return;

            ViewModel.Book.UsesCoverAsSpine = useCoverAsSpine;
        }
    }
}

