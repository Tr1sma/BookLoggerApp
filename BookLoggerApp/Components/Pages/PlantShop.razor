@page "/shop"
@using BookLoggerApp.Core.ViewModels
@using BookLoggerApp.Core.Models
@using BookLoggerApp.Components.Shared
@inject PlantShopViewModel ViewModel
@inject NavigationManager Navigation

<PageTitle>Plant Shop - BookLogger</PageTitle>

<div class="plant-shop-container">
    <!-- Header -->
    <div class="shop-header">
        <h1>üå± Plant Shop</h1>
        <div class="user-stats">
            <div class="stat-coin">
                <span class="coin-icon">ü™ô</span>
                <span class="coin-count">@ViewModel.UserCoins Coins</span>
            </div>
            <div class="stat-level">
                <span>Level @ViewModel.UserLevel</span>
            </div>
        </div>
    </div>

    <!-- Description -->
    <div class="shop-description">
        <p>üåø Welcome to the Plant Shop! Buy plants to grow as you read. Each plant has unique growth rates and care requirements.</p>
    </div>

    <!-- Leveling Info Box -->
    <div class="info-box">
        <h4>üìö Wie leveln Pflanzen?</h4>
        <ul>
            <li>üìñ Ein <strong>Lesetag</strong> = Tag mit mind. 15 Min Lesezeit</li>
            <li>üå± <strong>3 Lesetage</strong> = 1 Level (bei Growth Rate 1.0)</li>
            <li>‚ö° <strong>Growth Rate 1.2</strong> = 20% schneller (~2.5 Tage/Level)</li>
            <li>üê¢ <strong>Growth Rate 0.8</strong> = 20% langsamer (~3.75 Tage/Level)</li>
            <li>‚ú® H√∂heres Level = H√∂herer XP-Boost beim Lesen</li>
        </ul>
    </div>

    @if (ViewModel.IsBusy)
    {
        <div class="loading">Loading shop...</div>
    }
    else if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
    {
        <div class="alert alert-danger">
            @ViewModel.ErrorMessage
            <button class="btn-close-alert" @onclick="() => ViewModel.ErrorMessage = null">√ó</button>
        </div>
    }
    else
    {
        <!-- Shop Grid -->
        <div class="shop-grid">
            @foreach (var species in ViewModel.AvailableSpecies)
            {
                <PlantShopCard
                    Species="@species"
                    UserCoins="@ViewModel.UserCoins"
                    UserLevel="@ViewModel.UserLevel"
                    CurrentPrice="@ViewModel.GetDynamicPrice(species.Id)"
                    IsSelected="@(ViewModel.SelectedSpecies?.Id == species.Id)"
                    OnSelect="() => ViewModel.SelectSpeciesCommand.Execute(species)" />
            }
        </div>

        @if (!ViewModel.AvailableSpecies.Any())
        {
            <div class="empty-state">
                <h3>No plants available</h3>
                <p>Level up to unlock more plants!</p>
            </div>
        }
    }

    <!-- Purchase Modal -->
    @if (ViewModel.SelectedSpecies != null)
    {
        <div class="purchase-modal-overlay" @onclick="ViewModel.ClearSelectionCommand.Execute">
            <div class="purchase-modal" @onclick:stopPropagation="true">
                <div class="modal-header">
                    <h2>Purchase @ViewModel.SelectedSpecies.Name</h2>
                    <button class="btn-close" @onclick="ViewModel.ClearSelectionCommand.Execute">√ó</button>
                </div>

                <div class="modal-body">
                    <div class="plant-preview">
                        <img src="@ViewModel.SelectedSpecies.ImagePath" alt="@ViewModel.SelectedSpecies.Name" />
                    </div>

                    <div class="plant-details">
                        <p class="plant-description">@ViewModel.SelectedSpecies.Description</p>

                        <div class="plant-stats-grid">
                            <div class="stat-item">
                                <label>Max Level</label>
                                <span>@ViewModel.SelectedSpecies.MaxLevel</span>
                            </div>
                            <div class="stat-item">
                                <label>Water Interval</label>
                                <span>Every @ViewModel.SelectedSpecies.WaterIntervalDays days</span>
                            </div>
                            <div class="stat-item">
                                <label>Growth Rate</label>
                                <span>@ViewModel.SelectedSpecies.GrowthRate.ToString("0.0")x</span>
                            </div>
                            <div class="stat-item">
                                <label>Cost</label>
                                <span>ü™ô @ViewModel.GetDynamicPrice(ViewModel.SelectedSpecies.Id)</span>
                            </div>
                        </div>

                        <div class="name-input-group">
                            <label>Name your plant (optional):</label>
                            <input type="text"
                                   class="plant-name-input"
                                   placeholder="@($"Default: {ViewModel.SelectedSpecies.Name}")"
                                   @bind="ViewModel.NewPlantName"
                                   @bind:event="oninput"
                                   maxlength="100" />
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="ViewModel.ClearSelectionCommand.Execute">
                        Cancel
                    </button>
                    <button class="btn btn-primary"
                            @onclick="HandlePurchaseAsync"
                            disabled="@(ViewModel.UserCoins < ViewModel.GetDynamicPrice(ViewModel.SelectedSpecies.Id))">
                        @if (ViewModel.UserCoins >= ViewModel.GetDynamicPrice(ViewModel.SelectedSpecies.Id))
                        {
                            <span>Purchase for ü™ô @ViewModel.GetDynamicPrice(ViewModel.SelectedSpecies.Id)</span>
                        }
                        else
                        {
                            <span>Not Enough Coins</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    }
</div>

@code {
    protected override async Task OnInitializedAsync()
    {
        await ViewModel.LoadCommand.ExecuteAsync(null);
    }

    protected override async Task OnParametersSetAsync()
    {
        // Refresh when navigating back to the page
        if (ViewModel.AvailableSpecies.Any())
        {
            await ViewModel.LoadCommand.ExecuteAsync(null);
        }
    }

    private async Task HandlePurchaseAsync()
    {
        if (ViewModel.SelectedSpecies != null)
        {
            await ViewModel.PurchasePlantCommand.ExecuteAsync(ViewModel.SelectedSpecies.Id);

            // Navigate to Bookshelf after successful purchase
            if (string.IsNullOrEmpty(ViewModel.ErrorMessage))
            {
                Navigation.NavigateTo("/bookshelf");
            }
            else
            {
                StateHasChanged(); // Force UI update if there was an error
            }
        }
    }
}
