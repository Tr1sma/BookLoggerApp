@page "/settings"
@using BookLoggerApp.Core.ViewModels
@implements IDisposable
@inject SettingsViewModel ViewModel
@inject BookLoggerApp.Core.Services.Abstractions.IBackButtonService BackButtonService

<PageTitle>Settings - BookHeart</PageTitle>

<div class="settings-container">
    <h1 class="settings-title">Settings</h1>

    @if (ViewModel.IsBusy)
    {
        <div class="loading">Loading settings...</div>
    }
    else if (!string.IsNullOrEmpty(ViewModel.ErrorMessage))
    {
        <div class="alert alert-danger">@ViewModel.ErrorMessage</div>
    }
    else
    {
        <!-- About -->
        <section class="settings-section">
            <h2>About</h2>
            <div class="about-info">
                <p class="app-name">BookHeart</p>
                <p class="app-version">Version @ViewModel.AppVersion</p>
            </div>
        </section>

        <!-- Notifications -->
        <section class="settings-section">
            <h2>Notifications</h2>

            <div class="setting-row">
                <div class="setting-info">
                    <span class="setting-label">Enable Notifications</span>
                    <span class="setting-description">Allow BookHeart to send you notifications</span>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox"
                           checked="@ViewModel.Settings.NotificationsEnabled"
                           @onchange="@(async (ChangeEventArgs e) => await ViewModel.ToggleNotificationsCommand.ExecuteAsync((bool)(e.Value ?? false)))" />
                    <span class="toggle-slider"></span>
                </label>
            </div>

            @if (ViewModel.Settings.NotificationsEnabled)
            {
                <div class="setting-row">
                    <div class="setting-info">
                        <span class="setting-label">Daily Reading Reminder</span>
                        <span class="setting-description">Get a daily nudge to read</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox"
                               checked="@ViewModel.Settings.ReadingRemindersEnabled"
                               @onchange="@(async (ChangeEventArgs e) => await ViewModel.ToggleReadingRemindersCommand.ExecuteAsync((bool)(e.Value ?? false)))" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                @if (ViewModel.Settings.ReadingRemindersEnabled)
                {
                    <div class="setting-row time-picker-row">
                        <div class="setting-info">
                            <span class="setting-label">Reminder Time</span>
                            <span class="setting-description">When should we remind you?</span>
                        </div>
                        <div class="time-picker">
                            <select class="time-select"
                                    value="@ViewModel.ReminderHour"
                                    @onchange="@(async (ChangeEventArgs e) => { ViewModel.ReminderHour = int.Parse(e.Value?.ToString() ?? "20"); await ViewModel.UpdateReminderTimeCommand.ExecuteAsync(null); })">
                                @for (int h = 0; h < 24; h++)
                                {
                                    var hour = h;
                                    <option value="@hour">@hour.ToString("D2")</option>
                                }
                            </select>
                            <span class="time-separator">:</span>
                            <select class="time-select"
                                    value="@ViewModel.ReminderMinute"
                                    @onchange="@(async (ChangeEventArgs e) => { ViewModel.ReminderMinute = int.Parse(e.Value?.ToString() ?? "0"); await ViewModel.UpdateReminderTimeCommand.ExecuteAsync(null); })">
                                @for (int m = 0; m < 60; m++)
                                {
                                    var minute = m;
                                    <option value="@minute">@minute.ToString("D2")</option>
                                }
                            </select>
                        </div>
                    </div>
                }
            }
        </section>

        <!-- Migration Diagnostics -->
         <section class="settings-section">
            <h2>Data Recovery Diagnostics</h2>
            <div class="migration-log-container">
                <textarea class="migration-log" readonly>@ViewModel.MigrationLog</textarea>
            </div>
             <p class="description" style="margin-top: 0.5rem; font-size: 0.8rem;">
                If data is missing, screenshot this log and send it to support.
            </p>
        </section>

        <!-- Backup & Restore -->
        <section class="settings-section">
            <h2>Backup & Restore</h2>
            <div class="backup-actions">
                <p class="description">
                    Save your data (including book covers) to the cloud or another device.
                </p>
                <div class="button-group">
                    <button class="btn btn-primary" @onclick="() => ViewModel.BackupToCloudCommand.ExecuteAsync(null)">
                        Backup to Cloud
                    </button>
                    <button class="btn btn-secondary" @onclick="() => ViewModel.RestoreFromBackupCommand.ExecuteAsync(null)">
                        Restore from Backup
                    </button>
                </div>
            </div>
        </section>

        <!-- Danger Zone -->
        <section class="settings-section danger-zone">
            <h2>Danger Zone</h2>
            <p class="danger-description">
                Delete all your books, reading sessions, goals, plants, and reset your progress.
                This action cannot be undone.
            </p>
            <button class="btn btn-danger" @onclick="ShowDeleteConfirmation">
                Delete All Data
            </button>
        </section>

        <!-- Privacy & Legal -->
        <section class="settings-section privacy-section">
            <h2>Privacy & Legal</h2>
            <button class="privacy-toggle" @onclick="TogglePrivacyPolicy">
                <span>Privacy Policy</span>
                <span class="toggle-icon">@(_showPrivacyPolicy ? "▲" : "▼")</span>
            </button>

            @if (_showPrivacyPolicy)
            {
                <div class="privacy-content">
                    <p class="privacy-updated">Last updated: February 2026</p>

                    <h3>Overview</h3>
                    <p>
                        BookHeart is an offline-first book tracking app. Your data is stored
                        locally on your device and is never transmitted to our servers. We do not
                        collect, store, or share any personal information.
                    </p>

                    <h3>Data Storage</h3>
                    <p>
                        All your books, reading sessions, goals, plants, and settings are stored
                        in a local database (SQLite) on your device. This data never leaves your
                        device unless you explicitly use the Backup & Restore feature.
                    </p>

                    <h3>Camera Permission</h3>
                    <p>
                        BookHeart requests camera access solely for scanning book barcodes (ISBN).
                        No photos or videos are captured, stored, or transmitted. Camera access
                        is optional and can be denied without affecting other app features.
                    </p>

                    <h3>Network Usage</h3>
                    <p>
                        When you look up a book by ISBN, BookHeart sends the ISBN number to the
                        Google Books API to retrieve book metadata (title, author, cover image).
                        No personal data or device identifiers are included in these requests.
                        The app functions fully offline without this feature.
                    </p>

                    <h3>Third-Party Services</h3>
                    <p>
                        BookHeart does not include any advertising, analytics, or tracking SDKs.
                        The only external service used is the Google Books API for optional book
                        metadata lookup.
                    </p>

                    <h3>Data Deletion</h3>
                    <p>
                        You can delete all your data at any time using the "Delete All Data"
                        option in Settings. Uninstalling the app also removes all stored data
                        from your device.
                    </p>

                    <h3>Children's Privacy</h3>
                    <p>
                        BookHeart does not knowingly collect any information from children.
                        The app does not require account creation or any personal information
                        to function.
                    </p>

                    <h3>Changes to This Policy</h3>
                    <p>
                        Any changes to this privacy policy will be reflected in app updates.
                        The "Last updated" date at the top indicates the most recent revision.
                    </p>

                    <h3>Contact</h3>
                    <p>
                        If you have questions about this privacy policy, please open an issue
                        on our GitHub repository or contact us via the Play Store listing.
                    </p>
                </div>
            }
        </section>
    }
</div>

<!-- Delete Confirmation Modal -->
@if (_showDeleteConfirmation)
{
    <div class="modal-overlay" @onclick="HideDeleteConfirmation">
        <div class="modal-content delete-modal" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Delete All Data?</h3>
            </div>
            <div class="modal-body">
                <p class="warning-text">
                    This will permanently delete:
                </p>
                <ul class="delete-list">
                    <li>All your books</li>
                    <li>All reading sessions</li>
                    <li>All reading goals</li>
                    <li>All plants</li>
                    <li>Your level and XP progress</li>
                    <li>Your coins</li>
                </ul>
                <p class="confirm-text">
                    Type <strong>DELETE</strong> to confirm:
                </p>
                <input type="text"
                       class="confirm-input"
                       @bind="_deleteConfirmText"
                       @bind:event="oninput"
                       placeholder="Type DELETE" />
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="HideDeleteConfirmation">Cancel</button>
                <button class="btn btn-danger"
                        @onclick="ConfirmDeleteAllData"
                        disabled="@(!IsDeleteConfirmed)">
                    Delete Everything
                </button>
            </div>
        </div>
    </div>
}

<!-- Success Modal -->
@if (_showSuccessModal)
{
    <div class="modal-overlay" @onclick="CloseSuccessAndNavigate">
        <div class="modal-content success-modal" @onclick:stopPropagation="true">
            <div class="modal-body">
                <div class="success-icon">&#10003;</div>
                <h3>Data Deleted</h3>
                <p>All your data has been deleted. Starting fresh!</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" @onclick="CloseSuccessAndNavigate">OK</button>
            </div>
        </div>
    </div>
}

<style>
    .settings-container {
        padding: 1rem;
        max-width: 600px;
        margin: 0 auto;
        padding-bottom: 100px;
    }

    .settings-title {
        font-size: 1.5rem;
        color: var(--text-primary);
        margin-bottom: 1.5rem;
        font-weight: 600;
    }

    .settings-section {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
    }

    .settings-section h2 {
        font-size: 1.1rem;
        color: var(--text-primary);
        margin: 0 0 1rem 0;
        font-weight: 600;
    }

    .about-info {
        text-align: center;
    }

    .app-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .app-version {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin: 0.25rem 0 0 0;
    }

    .description {
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .button-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .danger-zone {
        border-color: rgba(220, 53, 69, 0.3);
        background: rgba(220, 53, 69, 0.05);
    }

    .danger-zone h2 {
        color: #dc3545;
    }

    .danger-description {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-bottom: 1rem;
        line-height: 1.5;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.2s ease;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover:not(:disabled) {
        background: #c82333;
    }

    .btn-danger:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .btn-secondary {
        background: var(--card-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
    }

    .btn-secondary:hover {
        background: var(--hover-bg);
    }

    .btn-primary {
        background: var(--accent-color);
        color: white;
    }

    .btn-primary:hover {
        filter: brightness(1.1);
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.85);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 1rem;
    }

    .modal-content {
        background: var(--card-bg);
        border-radius: 16px;
        width: 100%;
        max-width: 400px;
        overflow: hidden;
        border: 1px solid var(--border-color);
    }

    .delete-modal .modal-header {
        background: rgba(220, 53, 69, 0.1);
        padding: 1rem 1.25rem;
        border-bottom: 1px solid rgba(220, 53, 69, 0.2);
    }

    .delete-modal .modal-header h3 {
        color: #dc3545;
        margin: 0;
        font-size: 1.1rem;
    }

    .modal-body {
        padding: 1.25rem;
    }

    .warning-text {
        color: var(--text-primary);
        margin: 0 0 0.75rem 0;
        font-weight: 500;
    }

    .delete-list {
        margin: 0 0 1rem 0;
        padding-left: 1.5rem;
        color: var(--text-secondary);
        font-size: 0.9rem;
        line-height: 1.6;
    }

    .confirm-text {
        color: var(--text-primary);
        margin: 0 0 0.5rem 0;
        font-size: 0.9rem;
    }

    .confirm-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-primary);
        color: var(--text-primary);
        font-size: 1rem;
        text-align: center;
        letter-spacing: 2px;
    }

    .confirm-input:focus {
        outline: none;
        border-color: #dc3545;
    }

    .modal-footer {
        padding: 1rem 1.25rem;
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        border-top: 1px solid var(--border-color);
    }

    /* Success Modal */
    .success-modal .modal-body {
        text-align: center;
        padding: 2rem 1.25rem;
    }

    .success-icon {
        width: 60px;
        height: 60px;
        background: var(--accent-color);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 1.5rem;
        color: white;
    }

    .success-modal h3 {
        color: var(--text-primary);
        margin: 0 0 0.5rem 0;
    }

    .success-modal p {
        color: var(--text-secondary);
        margin: 0;
    }

    .success-modal .modal-footer {
        justify-content: center;
    }

    /* Setting Rows */
    .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-light);
    }

    .setting-row:last-child {
        border-bottom: none;
    }

    .setting-info {
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
        flex: 1;
        min-width: 0;
    }

    .setting-label {
        color: var(--text-primary);
        font-size: 0.95rem;
        font-weight: 500;
    }

    .setting-description {
        color: var(--text-secondary);
        font-size: 0.8rem;
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 26px;
        flex-shrink: 0;
        margin-left: 1rem;
    }

    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 26px;
        transition: all 0.3s ease;
    }

    .toggle-slider::before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 2px;
        bottom: 2px;
        background-color: var(--text-secondary);
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .toggle-switch input:checked + .toggle-slider {
        background-color: var(--accent-color);
        border-color: var(--accent-color);
    }

    .toggle-switch input:checked + .toggle-slider::before {
        transform: translateX(22px);
        background-color: var(--bg-primary);
    }

    /* Time Picker */
    .time-picker-row {
        flex-wrap: wrap;
    }

    .time-picker {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        flex-shrink: 0;
        margin-left: 1rem;
    }

    .time-select {
        background: var(--bg-primary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem 0.6rem;
        font-size: 0.95rem;
        text-align: center;
        appearance: none;
        -webkit-appearance: none;
        cursor: pointer;
        min-width: 52px;
    }

    .time-select:focus {
        outline: none;
        border-color: var(--accent-color);
    }

    .time-separator {
        color: var(--text-primary);
        font-size: 1.1rem;
        font-weight: 600;
    }

    .loading {
        text-align: center;
        color: var(--text-secondary);
        padding: 2rem;
    }

    .alert-danger {
        background: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        padding: 1rem;
        border-radius: 8px;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .migration-log-container {
        width: 100%;
    }

    .migration-log {
        width: 100%;
        height: 150px;
        background: var(--bg-primary);
        color: var(--text-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 0.5rem;
        font-family: monospace;
        font-size: 0.8rem;
        resize: vertical;
    }

    /* Privacy & Legal */
    .privacy-section {
        margin-top: 1rem;
    }

    .privacy-toggle {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        padding: 0.75rem 0;
        background: none;
        border: none;
        color: var(--text-primary);
        font-size: 0.95rem;
        cursor: pointer;
    }

    .toggle-icon {
        color: var(--text-secondary);
        font-size: 0.8rem;
    }

    .privacy-content {
        padding: 0.5rem 0;
        border-top: 1px solid var(--border-color);
    }

    .privacy-content h3 {
        font-size: 0.95rem;
        color: var(--text-primary);
        margin: 1rem 0 0.4rem 0;
        font-weight: 600;
    }

    .privacy-content p {
        color: var(--text-secondary);
        font-size: 0.85rem;
        line-height: 1.6;
        margin: 0 0 0.5rem 0;
    }

    .privacy-updated {
        font-style: italic;
        color: var(--text-secondary);
        font-size: 0.8rem !important;
    }
</style>

@code {
    private bool _showDeleteConfirmation = false;
    private bool _showSuccessModal = false;
    private bool _showPrivacyPolicy = false;
    private string _deleteConfirmText = string.Empty;

    private bool IsDeleteConfirmed => _deleteConfirmText.Equals("DELETE", StringComparison.Ordinal);

    private void TogglePrivacyPolicy() => _showPrivacyPolicy = !_showPrivacyPolicy;

    private Func<Task<bool>>? _navBackHandler;
    private Func<Task<bool>>? _modalBackHandler;

    protected override async Task OnInitializedAsync()
    {
        // Register navigation back handler (Settings -> Bookshelf)
        _navBackHandler = async () => 
        {
            Navigation.NavigateTo("/");
            return true;
        };
        BackButtonService.Register(_navBackHandler);

        await ViewModel.LoadCommand.ExecuteAsync(null);
    }

    private void ShowDeleteConfirmation()
    {
        _deleteConfirmText = string.Empty;
        
         // Register modal back handler
        _modalBackHandler = async () =>
        {
            HideDeleteConfirmation();
            return true;
        };
        BackButtonService.Register(_modalBackHandler);
        
        _showDeleteConfirmation = true;
    }

    private void HideDeleteConfirmation()
    {
        if (_modalBackHandler != null)
        {
            BackButtonService.Unregister(_modalBackHandler);
            _modalBackHandler = null;
        }
        _showDeleteConfirmation = false;
        _deleteConfirmText = string.Empty;
    }

    private async Task ConfirmDeleteAllData()
    {
        if (!IsDeleteConfirmed) return;

        _showDeleteConfirmation = false;
        if (_modalBackHandler != null)
        {
            BackButtonService.Unregister(_modalBackHandler);
            _modalBackHandler = null;
        }

        await ViewModel.DeleteAllDataCommand.ExecuteAsync(null);

        if (string.IsNullOrEmpty(ViewModel.ErrorMessage))
        {
            _showSuccessModal = true;
            // Register success modal handler (just close/navigate)
             _modalBackHandler = async () =>
            {
                CloseSuccessAndNavigate();
                return true;
            };
            BackButtonService.Register(_modalBackHandler);
        }
    }

    private void CloseSuccessAndNavigate()
    {
        if (_modalBackHandler != null)
        {
            BackButtonService.Unregister(_modalBackHandler);
            _modalBackHandler = null;
        }
        _showSuccessModal = false;
        // Force page refresh to reflect reset state
        Navigation.NavigateTo("/", forceLoad: true);
    }

    [Inject]
    private NavigationManager Navigation { get; set; } = default!;
    
    public void Dispose()
    {
        if (_navBackHandler != null)
        {
            BackButtonService.Unregister(_navBackHandler);
            _navBackHandler = null;
        }
         if (_modalBackHandler != null)
        {
            BackButtonService.Unregister(_modalBackHandler);
            _modalBackHandler = null;
        }
    }
}
